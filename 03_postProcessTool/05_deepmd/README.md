# 1. 项目功能

针对deepmd-kit进行深度势能训练的数据处理脚本

# 2. 文件结构

```py
01_extract_poscar-from-vmd_frames.py             # vmd导出的poscar文件标准化及指定帧提取
02_frc_unit_converter_hartree_bohr.py            # frc.xyz文件单位转换
03_extract_xyz_every_n_frames.py                 # xyz文件每10帧提取一帧
04_plot_lcurve.py                                # X 轴和 Y 轴都用对数刻度（plt.loglog），适合同时跨越大范围的步数和损失值
04-2_xyPlot_lcurve.py                            # X、Y 轴均为线性刻度（plt.plot），用于数据变化幅度较小且接近线性的情况
04-3_ySemi_plot_lcurve.py                        # X 轴线性、Y 轴对数刻度（plt.semilogy），强调损失值的指数级变化，而保留步数的线性分布
05-1_plot_energy_correlation.py                  # 能量预测，该脚本在超算上进行绘图，绘图前请加载 deepmd-kit 虚拟环境
05-2_plot_force_correlation.py                   # 力(xyz分量)预测，该脚本在超算上进行绘图，绘图前请加载 deepmd-kit 虚拟环境
```




# 1. 01_extract_poscar-from-vmd_frames.py

[01_extract_poscar-from-vmd_frames.py](01_extract_poscar-from-vmd_frames.py)

- vmd导出的poscar文件标准化及指定帧提取

## 1. vmd输出poscar数据格式

```
B   O   Si  Ca  
      1.000000000000
     14.875200271606        0.000000000000        0.000000000000
      0.000000000000       14.875200271606        0.000000000000
      0.000000000000        0.000000000000       14.875200271606
 8  135  40  43 
Direct
      0.324629924852       0.882626102256       0.598300539987 
      0.789967070951       0.599929361733       0.317764043058 
      0.729609627730       0.101514779862       0.645540473778 
      0.661922871322       0.918706113140       0.684908517098 
      0.051849785110       0.098404000236       0.491051033038 
      0.428460739728       0.341228346756       0.857410459362 
      ...
      0.497273169294       0.747559171569       0.408897504504 
      0.667677408923       0.220784348258       0.290419314854 
      0.235927066022       0.090740761280       0.813329180605 
      0.875539708284       0.144658328898       0.924219270206 
B   O   Si  Ca  
      1.000000000000
     14.875200271606        0.000000000000        0.000000000000
      0.000000000000       14.875200271606        0.000000000000
      0.000000000000        0.000000000000       14.875200271606
 8  135  40  43 
Direct
      0.325318676801       0.883975268785       0.599541357750 
      0.789858914520       0.600849749240       0.317666272722 
      0.730018916797       0.101273198977       0.644143992817 
      0.662715676553       0.919356526295       0.684786063759 
      0.052275406632       0.098939677498       0.491217018219 
      0.427974388403       0.341230526553       0.856245421624 
      0.607148338693       0.517345483440       0.890189936028 
      ...
      0.235929309931       0.090390390862       0.813695514836 
      0.875653570656       0.143907709162       0.924109190424 
B   O   Si  Ca  
      1.000000000000
     14.875200271606        0.000000000000        0.000000000000
      0.000000000000       14.875200271606        0.000000000000
      0.000000000000        0.000000000000       14.875200271606
 8  135  40  43 
Direct
      0.325991785497       0.885430796617       0.600835388220 
      0.789693185786       0.601703973476       0.317604757549 
      0.730377237065       0.101011438937       0.642726867891 
      0.663513738944       0.919983154011       0.684655019452 
      0.052674261520       0.099442593682       0.491433523416 
      ...
      0.875821415076       0.143196197561       0.924089508134 
...
```


## 2. 编程思路

我有一个vmd导出的多帧 poscar 文件（部分内容如上所示），我想要提取其中的某些帧分别保存为单独的poscar文件，能否帮我编写一个python脚本实现上述功能？需求如下：
1. 打印当前目录（不含子目录）下的所有文件名，提示用户输入需要处理的数据文件名（提示用户：vmd导出的poscar文件）
2. 该poscar文件中，每一帧的原子数相同，因此统计 Direct (或Cartesian) 关键词的数量就可以知道该poscar文件中的帧数。通过判断相邻两个Direct (或Cartesian) 关键词间隔的行数就可以知道不同帧的原子数是否相同
3. 基于文件的总行数除以总帧数，就可以得到每帧的行数（必须满足整除，否则可能不同帧原子数不同），基于此就可以确定每帧的起始和结束行数
4. 打印文件的总帧数。提示用户输入想要提取的帧数，支持如下2种方式：
   - 输入具体帧数的索引，使用英文逗号分隔，使用"-"代表范围，例如：0,10,15,99,150-155,200，其中150-155代表从150到155的帧数索引。
   - 指定帧数范围a到b，每隔c提取一帧，类似于python的range函数，即list(range(a,b,c))列表中的帧数索引，提示用户输入a,b,c三个数，使用英文逗号分隔
5. 在提取前打印出用户输入的帧数索引及总数，请用户输入y进行确认
6. 按照 `index_"对应索引"_POSCAR` 方式命名，将相应帧写入到对应文件中。注意各帧写入时，应当将各帧第一行内容复制，然后插入到第6行，原第6及之后的行要各自后移一行，以满足现在poscar文件的要求（第6行是元素符号）




# 2. 02_frc_unit_converter_hartree_bohr.py

[02_frc_unit_converter_hartree_bohr.py](02_frc_unit_converter_hartree_bohr.py)

- frc.xyz文件单位转换

## 1. 编程思路

1. 打印当前目录下的所有文件名（不含子文件夹中的文件），提示用户输入需要读取的文件名（通常是 `*.frc.xyz` 文件）。
2. 读取该文件的所有行，从第一行开始遍历，如果该行包含4列，列和列之间使用空格分隔，且第一列为字符串，后三列为数值，则需要将后三列的数值分别乘以一个系数，该系数是 2.015529557777。这是因为，该文件中默认这三列的单位是 `amu·Å/fs²`，乘以该系数后，单位转换为 `Hartree/Bohr`，转换后的数值应当与转换前的数值具有相同的小数位数（小数点后保留10位）。
3. 进行一致性检验，检索文档中字符"time"出现的次数a，计数文档非空行的总行数b，计数文档中需要进行数值转换的行数为c。如果a，b和c满足 `2*a+c=b`一致性检验，则进行上述数值转换，否则结束程序运行，并给出提示。
4. 完成上述数值转换后，保存到新文件 "Hartree-Bohr_"+原文件名。



# 3. 03_extract_xyz_every_n_frames.py

[03_extract_xyz_every_n_frames.py](03_extract_xyz_every_n_frames.py)

- xyz文件每10帧提取一帧

## 1. 编程思路

编写一个python脚本，实现以下需求：

1. 打印当前目录下的所有文件名（不含子文件夹中的文件），提示用户输入需要读取的文件名（通常是 `*.xyz` 文件）。
2. 由于该文件是一个多帧的xyz文件，并且每一帧的原子数相同，均为文件第一行的数值（假设为a）。因此，第1帧行数范围是 [1,a+2]，第2帧行数范围是 [a+3,2*(a+2)]，第i帧的行数范围是 [(i-1)*(a+2)+1,i*(a+2)]，请确认第i帧的行数范围计算是否正确。
3. 现在需要每n帧提取一帧，提示用户输入参数n，输入Enter默认为n为10，打印参数n的值。假如文件共有30帧，如果n为10，则提取第10，20，30帧。打印提取的总帧数b。
4. 将提取的相应帧写入到 0-b_every_10th_line.xyz 文件中。




# 4. lcurve.out 绘图

### 1. `04_plot_lcurve.py`

X 轴和 Y 轴都用对数刻度（plt.loglog），适合同时跨越大范围的步数和损失值。


<p align="center">
<img src="https://19640810.xyz/05_image/01_imageHost/20250626-092217.png" alt="Image Description" width="500">
</p>



### 2. `04-2_xyPlot_lcurve.py`

X、Y 轴均为线性刻度（plt.plot），用于数据变化幅度较小且接近线性的情况。


<p align="center">
<img src="https://19640810.xyz/05_image/01_imageHost/20250626-092251.png" alt="Image Description" width="500">
</p>




### 3. `04-3_ySemi_plot_lcurve.py`

X 轴线性、Y 轴对数刻度（plt.semilogy），强调损失值的指数级变化，而保留步数的线性分布。

<p align="center">
<img src="https://19640810.xyz/05_image/01_imageHost/20250626-092309.png" alt="Image Description" width="500">
</p>




# 5. 能量和力(xyz分量)预测


## 1. `05-1_plot_energy_correlation.py`

注意：该脚本在超算上进行绘图，绘图前请加载 deepmd-kit 虚拟环境

1. 从 DeepMD 格式的数据集中读取 DFT 能量，并使用训练好的深度势模型（graph.pb）对能量进行预测。

2. 将真实 DFT 能量与预测能量绘制散点图，添加 y=x 参考线后保存为 `energy_scatter.png`。

<p align="center">
<img src="https://19640810.xyz/05_image/01_imageHost/20250626-102622.png" alt="Image Description" width="500">
</p>




## 2. `05-2_plot_force_correlation.py`

注意：该脚本在超算上进行绘图，绘图前请加载 deepmd-kit 虚拟环境

1. 同样读取 DeepMD 数据并对力张量进行预测，然后将每个原子在 x、y、z 三个方向上的参考力与预测力分别展开为一维数组。

2. 针对每个分量绘制散点图并添加 y=x 参考线，标注单位、标题后保存为对应的 `force_x_scatter.png、force_y_scatter.png、force_z_scatter.png`。

<p align="center">
<img src="https://19640810.xyz/05_image/01_imageHost/20250626-102637.png" alt="Image Description" width="500">
</p>












