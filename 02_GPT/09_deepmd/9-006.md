# dp-gen输入文件和关键词

# 1. 概述

### 1. 基础知识

- `param.json` 文件作为 DP-GEN run 流程的核心配置文件，详细定义了用于指导系统和数据处理、模型训练、结构探索（模型偏差）以及第一性原理计算（标注）这四个关键步骤的各项参数和设置。

- 在DP-GEN中，`machine.json` 文件是任务调度器的配置文件。它定义了DP-GEN工作流程中不同步骤（特别是训练、探索（model_devi）和标记（fp）过程）的计算环境和资源要求。

- 一个 `model_devi_jobs` 任务（例如 `model_devi_jobs[0]`）会与其 `sys_idx` 对应的 `sys_configs` 项中所匹配到的每一个初始结构（POSCAR 文件）一起，启动一条独立的 MD 轨迹。 如果 `sys_configs[0]` 匹配到 10 个 POSCAR 文件，那么 `model_devi_jobs[0]` 将会运行 10 条独立的 NVT 模拟轨迹，每条轨迹从一个不同的 POSCAR 开始，持续 300 步。



### 2. dp-gen工作流


<p align="center">
<img src="https://19640810.xyz/05_image/01_imageHost/20250519-204029.png" alt="Image Description" width="600">
</p>


DP-GEN 的核心思想是主动学习和迭代优化。整个工作流大致如下：

1. 初始化 (Init): 使用少量初始数据训练一个 Deep Potential (DP) 模型。

2. 探索 (Model Deviance - model_devi_jobs 阶段):
   - DP-GEN 会使用当前训练好的 DP 模型，根据 model_devi_jobs 中定义的参数（如温度、压力、系统索引、模拟步数等），启动一系列 MD 模拟。
   - 这些 MD 模拟的目的是在相空间中进行“探索”，生成新的构型。
   - 在这些 MD 模拟过程中，DP 模型会实时预测每个构型的能量和力。
   - 同时，DP-GEN 会计算模型偏差（model deviation），通常是不同 DP 模型预测结果之间的力或能量差异。如果多个 DP 模型对某个构型的预测结果差异很大，说明当前模型对这个构型不够“自信”，这个构型可能是需要进一步标注的“不确定”构型。
   - 重要： 这个阶段只使用 DP 模型进行模拟，不涉及耗时的 DFT 计算。

3. 筛选 (Selection):
   - 在探索阶段结束后，DP-GEN 会分析所有 MD 轨迹中生成的构型。
   - 它会根据预设的偏差阈值（例如 model_devi_f_trust_lo 和 model_devi_f_trust_hi）来筛选出那些模型偏差超过阈值的构型。这些构型被认为是当前 DP 模型不确定性较高的构型，需要进行精确的第一性原理计算。

4. 第一性原理标注 (First Principles Calculation - fp 阶段):
   - 将上一步筛选出来的“不确定”构型提交给第一性原理计算软件（例如您提到的 CP2K）。
   - CP2K 会对这些构型进行精确的 DFT 计算，获取它们真实的能量、力和虚力。
   - 这是一个计算成本最高的阶段。

5. 数据收集与模型更新 (Data Collection & Model Update):
   - 将新收集到的 DFT 能量和力数据添加到现有的训练数据集中。
   - 使用包含新数据的整个数据集重新训练 DP 模型。这通常会生成一个更准确、泛化能力更强的 DP 模型。

6. 迭代 (Iteration):
   - 重复步骤 2-5，直到满足收敛条件（例如，模型偏差在所有探索的相空间中都低于某个阈值，或者达到最大迭代次数）。

7. 总结：
   - 先运行完 model_devi_jobs 中的任务： DP-GEN 会先利用已有的 DP 模型快速、大量地探索相空间，并找出模型预测不准确的构型。
   - 再进行 DFT 标注获取能量、力的精确值： 只有在发现模型不确定的构型后，才会将其提交给 CP2K 进行精确的 DFT 计算，以获取“真实”的能量和力值来纠正和完善模型。




### 3. 常见问题

- `sys_configs[0]` 通配符下的所有poscar文件都会被用于探索吗，不同的poscar跑多条轨迹呢？还是说一个 `model_devi_jobs[0]` 任务只会从中选用一个poscar文件跑一条轨迹呢？

- `"sys_batch_size"` 取值为 auto 时，批次大小是如何选取的呢？

- 运行 `model_devi_jobs` 中的MD任务，与调用cp2k进行DFT标注是同时进行的吗？还是说，先运行完 `model_devi_jobs` 中的任务，再进行DFT标注获取能量、力的偏差？

- dpgen在探索阶段会执行 `model_devi_jobs[0]和[1]` 两个任务，请问这两个任务是同时执行吗？

- 由于`sys_configs[0]和[1]`下面均有多个初始构型，每个初始构型都会生成一条MD轨迹，这些MD模拟是同时进行的吗？还有，dp-gen探索会在什么时候结束呢？model_devi_jobs[0]和[1]两个任务跑完就会结束吗？

- 在dp-gen进行DFT标注时，会使用上述template.inp作为模板文件，那么cp2k.py中的哪些函数会被调用，用来修改模板文件中的哪些信息呢？哪些参数会被修改，哪些不会被修改呢？

- 上述代码中，`sys_idx[0]和[1]`对应两个探索任务，每个探索任务会为`sys_configs[0]`和`[1]`下面匹配到的每个初始结构生成一条轨迹，请问这些轨迹是否都被保存，如果被保存了应该去哪个目录下查看呢？

- `sys_configs`路径下的初始构型文件除了poscar格式，还支持哪些格式呢？可以在哪些地方进行指定呢？






# 2. 甲烷/vasp/github官方

- dp-gen官方github在 `dpgen/examples/run/` 中提供了不同 `param.json` 的示例。
- 本节以 `dpgen/examples/run/dp2.x-lammps-vasp/param_CH4_deepmd-kit-2.0.1.json` 为例，描述 `param.json` 的功能。
- 这是一个针对气相甲烷分子的 `param.json` 文件，其中使用 `DeePMD-kit（v2.x）` 进行训练，LAMMPS 进行探索，VASP 进行标记。


## 1. 输入文件

### 1. `param_CH4_deepmd-kit-2.0.1.json`文件

```json
{
    "type_map": [
        "H",
        "C"
    ],
    "mass_map": [
        1,
        12
    ],
    "init_data_prefix": "./",
    "init_data_sys": [
        "CH4.POSCAR.01x01x01/02.md/sys-0004-0001/deepmd"
    ],
    "sys_configs_prefix": "./",
    "sys_configs": [
        [
            "CH4.POSCAR.01x01x01/01.scale_pert/sys-0004-0001/scale*/00000*/POSCAR"
        ],
        [
            "CH4.POSCAR.01x01x01/01.scale_pert/sys-0004-0001/scale*/00001*/POSCAR"
        ]
    ],
    "_comment1": " that's all ",
    "numb_models": 4,
    "default_training_param": {
        "model": {
            "type_map": [
                "H",
                "C"
            ],
            "descriptor": {
                "type": "se_a",
                "sel": [
                    16,
                    4
                ],
                "rcut_smth": 0.5,
                "rcut": 5.0,
                "neuron": [
                    120,
                    120,
                    120
                ],
                "resnet_dt": true,
                "axis_neuron": 12,
                "seed": 1
            },
            "fitting_net": {
                "neuron": [
                    25,
                    50,
                    100
                ],
                "resnet_dt": false,
                "seed": 1
            }
        },
        "learning_rate": {
            "type": "exp",
            "start_lr": 0.001,
            "decay_steps": 100
        },
        "loss": {
            "start_pref_e": 0.02,
            "limit_pref_e": 2,
            "start_pref_f": 1000,
            "limit_pref_f": 1,
            "start_pref_v": 0.0,
            "limit_pref_v": 0.0
        },
        "training": {
            "numb_steps": 2000,
            "batch_size": 1,
            "disp_file": "lcurve.out",
            "disp_freq": 1000,
            "save_freq": 1000,
            "save_ckpt": "model.ckpt",
            "disp_training": true,
            "time_training": true,
            "profiling": false,
            "profiling_file": "timeline.json",
            "_comment2": "that's all"
        }
    },
    "model_devi_dt": 0.002,
    "model_devi_skip": 0,
    "model_devi_f_trust_lo": 0.05,
    "model_devi_f_trust_hi": 0.15,
    "model_devi_clean_traj": true,
    "model_devi_jobs": [
        {
            "sys_idx": [
                0
            ],
            "temps": [
                100
            ],
            "press": [
                1.0
            ],
            "trj_freq": 10,
            "nsteps": 300,
            "ensemble": "nvt",
            "_idx": "00"
        },
        {
            "sys_idx": [
                1
            ],
            "temps": [
                100
            ],
            "press": [
                1.0
            ],
            "trj_freq": 10,
            "nsteps": 3000,
            "ensemble": "nvt",
            "_idx": "01"
        }
    ],
    "fp_style": "vasp",
    "shuffle_poscar": false,
    "fp_task_max": 20,
    "fp_task_min": 5,
    "fp_pp_path": "./",
    "fp_pp_files": [
        "POTCAR_H",
        "POTCAR_C"
    ],
    "fp_incar": "./INCAR_methane"
}
```



## 2. 关键词概述

### 1. basics

- `type_map`：定义参与体系的原子种类，本例为 `["H", "C"]`。

- `mass_map`：对应上面原子种类的原子量，本例为 `[1, 12]`。


### 2. data

```json
    "init_data_prefix": "./",
    "init_data_sys": [
        "CH4.POSCAR.01x01x01/02.md/sys-0004-0001/deepmd"
    ],
    "sys_configs_prefix": "./",
    "sys_configs": [
        [
            "CH4.POSCAR.01x01x01/01.scale_pert/sys-0004-0001/scale*/00000*/POSCAR"
        ],
        [
            "CH4.POSCAR.01x01x01/01.scale_pert/sys-0004-0001/scale*/00001*/POSCAR"
        ]
    ],
```


- `init_data_prefix & init_data_sys`：指定初始训练数据所在目录及子目录，用于第一轮模型训练。

- `sys_configs_prefix & sys_configs`：指定用于“模型偏差评估”（model_devi）阶段的结构集所在目录及模式匹配路径，文中将体系分为两组、分别对应两个子路径。

- `sys_configs[0]` 通配符下的所有 POSCAR 文件都会被用于探索。 如果通配符 `00000*/POSCAR` 匹配到了 N 个 POSCAR 文件，那么 `model_devi_jobs[0]` 这个任务就会使用这 N 个文件作为初始结构。





### 3. training

- `numb_models`：每轮训练要并行生成的子模型数（即用不同随机种子训练的模型个数），本例为 4。
- `default_training_param`：传递给 DeePMD-kit 的训练超参数（例如学习率、网络层次等），在此处留空，实际使用时参照 DeePMD-kit 文档填充。

- `axis_neuron`：指定嵌入矩阵中用于轴方向（axis）的子矩阵大小。

  - 在 SE-A 描述子里，会把原子对之间的“径向”信息和“角度”信息分别映射到两个子网络：一个是常规的多层感知器处理径向（neuron 数组）；另一个就是“轴”网络，用来处理由中心—邻居向量构成的方向性（角度）信息，`axis_neuron` 就是后者每层的神经元数量。

  - 它决定了模型对角度特征的表达能力——节点越多，能捕捉越复杂的角度相关性，但计算量也更大。

  - 如何选取，基于系统复杂度与径向网络的配合：

    - 对于简单的小分子（如 CH₄），角度分布较规则，`axis_neuron=8∼16` 通常足够；

    - 对于多组分、配位环境多变的无序体系（如液相金属、复杂氧化物），可以考虑 `axis_neuron=16∼32`，以增强对各向异性环境的分辨率。

    - 如果径向网络每层节点数很大（如 `[120,120,120]`），则角度网络也可适当加大；

    - 若径向网络较小（如 `[64,64]`），角度网络设得太大反而容易过拟合。

    - 经验值：多数文献和示例里，`axis_neuron` 取在 8～24 的区间既能兼顾精度，又不会显著拖累性能；如果你不确定，从 12 或 16 开始调参，逐步试验收敛性与预测误差，就能找到最优值。


- `resnet_dt`：布尔选项，若为 true，则在 ResNet 结构中使用时间步长信息。

  - `resnet_dt` 这个参数控制的是在 DeepMD-kit 网络中“是否使用 ResNet（残差）结构”——也就是说，在每一层输出上加上一条`“跳跃连接”`（skip connection），以缓解梯度消失、加快收敛。

  - `resnet_dt`何时设为 `true`：网络比较深、层数和节点数都较大（如  `"neuron": [240, 240, 240]` ），需要残差跳跃来保证梯度流动和加速收敛；

  - `resnet_dt`何时设为 `false`：网络较浅、参数量适中，不会出现梯度难以传播的情况。网络更浅，节点数较少（如只有三层 `25→50→100`），不加残差结构也能轻松训练；

  - 如果你希望网络更“平滑”地拟合能量/力场，也可以保持 false；但假如你把拟合网络也加深到五层、十层，就可以考虑把它改为 true，引入残差，提升训练稳定性。


```json
        "training": {
            "numb_steps": 2000,
            "batch_size": 1,
            "disp_file": "lcurve.out",
            "disp_freq": 1000,
            "save_freq": 1000,
            "save_ckpt": "model.ckpt",
            "disp_training": true,
            "time_training": true,
            "profiling": false,
            "profiling_file": "timeline.json",
            "_comment2": "that's all"
        }
```

- `batch_size: 1`
  - 每次迭代训练时从数据集中抽取的样本数（batch size）。1 表示逐帧（single-sample）训练，梯度更新更频繁；若你有足够显存或希望加速，可增大到 4、8、16 等。

- `save_ckpt: "model.ckpt"`
  - 指定检查点文件（checkpoint）的前缀或路径模板。训练过程中，每到 save_freq 步就会把当前模型权重保存为 `model.ckpt-<step>.data-00000-of-00001、.index、.meta` 等一系列文件，以便中途重启或回滚。

- `disp_training: true`
  - 是否在控制台（或日志）实时打印训练过程中的损失、学习率等细节。设为 true 可让你边训练边监控收敛情况；若想纯后台运行且减少 IO，可设为 false。

- `time_training: true`
  - 是否记录并输出训练耗时信息。开启后，每若干步会打印本轮或累计耗时，用以评估性能瓶颈和优化并行配置；若你不关心速度，亦可关掉。

- `profiling: false`
  - 是否开启更细粒度的性能剖析（profiling），收集各操作（前向、反向、I/O 等）的时间分布；仅在你需要诊断训练速度瓶颈时设为 true，否则留作 false。

- `profiling_file: "timeline.json"`
  - 当 `profiling=true` 时，指定剖析结果输出的文件名。你可以用 TensorBoard 或 Chrome tracing 加载该 `timeline.json`，可视化每一步的运算成本、CUDA 吞吐等。


### 4. exploration


```json
    "model_devi_dt": 0.002,
    "model_devi_skip": 0,
    "model_devi_f_trust_lo": 0.05,
    "model_devi_f_trust_hi": 0.15,
    "model_devi_clean_traj": true,
    "model_devi_jobs": [
        {
            "sys_idx": [
                0
            ],
            "temps": [
                100
            ],
            "press": [
                1.0
            ],
            "trj_freq": 10,
            "nsteps": 300,
            "ensemble": "nvt",
            "_idx": "00"
        },
        {
            "sys_idx": [
                1
            ],
            "temps": [
                100
            ],
            "press": [
                1.0
            ],
            "trj_freq": 10,
            "nsteps": 3000,
            "ensemble": "nvt",
            "_idx": "01"
        }
    ],
```


- `model_devi_dt`：MD 时间步长（单位 ps，本例 0.002）。
- `model_devi_skip`：跳过多少步不保存结构（本例 0）。
- `model_devi_f_trust_lo` 与 `model_devi_f_trust_hi`：力偏差筛选阈值下限（0.05 eV/Å）和上限（0.15 eV/Å）。
- `model_devi_clean_traj`：是否清理中间轨迹文件夹（默认 true）。
- `model_devi_jobs` 列表：针对不同结构组分别设置 MD 任务
  - `sys_idx`：引用 `sys_configs` 中的哪一组结构。
  - `temps, press`：温度（K）和压力（Bar）。
  - `trj_freq`：保存轨迹的频率（步数）。
  - `nsteps`：总运行步数。
  - `ensemble`：热力学系综（如 "nvt"）。
  - `_idx`：该作业的内部索引标签。


- `model_devi_jobs` 中的每一个字典定义了一个模型偏差（model deviation）模拟任务。`"sys_idx": [0]` 表示 `model_devi_jobs[0]` 这个任务将使用 `sys_configs` 列表中索引为 0 的那一项所指定的所有初始结构。

- 对于 `model_devi_jobs[0]` 任务，DP-GEN 会为 `sys_configs[0]` 中匹配到的每一个 POSCAR 文件启动一个独立的 MD 模拟轨迹，这些轨迹都将使用 `model_devi_jobs[0]` 中定义的参数（如温度、步数、系综等）。

- 配置文件中的 `model_devi_clean_traj` 设置为 `true`，表示在每次模型偏差（model deviation）计算后，轨迹文件会被清理（删除），以节省磁盘空间。因此，轨迹默认不会被永久保存。





### 5. labeling


```json
    "fp_style": "vasp",
    "shuffle_poscar": false,
    "fp_task_max": 20,
    "fp_task_min": 5,
    "fp_pp_path": "./",
    "fp_pp_files": [
        "POTCAR_H",
        "POTCAR_C"
    ],
    "fp_incar": "./INCAR_methane"
```

- `fp_style: "vasp"`
  - 指定用来做第一性原理标注（Labeling）的软件，常见选项还有 "pwscf"（Quantum ESPRESSO）、"siesta"、"gaussian" 等；这里用 VASP。

- `shuffle_poscar: false`
  - 是否在提交 DFT 任务前打乱候选 POSCAR 列表；false 保持原有顺序，true 可避免始终计算同一批构型。

- `fp_task_max: 20`
  - 每轮迭代中最多提交给 DFT 计算的构型数。当候选总数超过此值时，会随机截取至多 20 个。

- `fp_task_min: 5`
  - 每轮迭代中最少要提交的构型数。如果候选总数低于 5 个，就全部提交，保证每轮至少有 5 个新增标注。

- `fp_pp_path: "./"`
  - 存放赝势文件（POTCAR、pseudo 文件）的目录前缀，后面再与 `fp_pp_files` 拼接定位到具体文件。

- `fp_pp_files: ["POTCAR_H","POTCAR_C"]`
  - 赝势文件名列表，顺序必须对应 type_map 中的元素顺序；这里依次为 H 和 C 的 POTCAR。

- `fp_incar: "./INCAR_methane"`
  - 第一性原理计算的 INCAR 文件路径，用来指定 VASP 里的收敛参数、k-point 网格（KSPACING/KGAMMA）等。




参考资料：
- https://github.com/deepmodeling/dpgen/tree/master/examples/run/dp2.x-lammps-vasp
- [Example-of-param.json](https://docs.deepmodeling.com/projects/dpgen/en/devel/run/example-of-param.html)





# 3. 甲烷/cp2k/github官方

## 1.1 `param-ch4.json`文件

### 1. 输入文件

```json
{
    "type_map": [
        "H",
        "C"
    ],
    "mass_map": [
        1,
        12
    ],
    "init_data_prefix": "/data/ybzhuang/methane-dpgen/dpgen-tutorial-2020-08-23/dpgen-tutorial-mathane/data",
    "init_data_sys": [
        "deepmd"
    ],
    "init_batch_size": [
        8
    ],
    "sys_configs": [
        [
            "/data/ybzhuang/methane-dpgen/dpgen-tutorial-2020-08-23/dpgen-tutorial-mathane/data/CH4.POSCAR.01x01x01/01.scale_pert/sys-0004-0001/scale-1.000/00000*/POSCAR"
        ],
        [
            "/data/ybzhuang/methane-dpgen/dpgen-tutorial-2020-08-23/dpgen-tutorial-mathane/data/CH4.POSCAR.01x01x01/01.scale_pert/sys-0004-0001/scale-1.000/00000*/POSCAR"
        ]
    ],
    "sys_batch_size": [
        8,
        8
    ],
    "_comment1": " that's all ",
    "numb_models": 4,
    "default_training_param": {
        "model": {
            "descriptor": {
                "type": "se_a",
                "sel": [
                    16,
                    4
                ],
                "rcut_smth": 0.5,
                "rcut": 5.0,
                "_comment2": "modify according your system",
                "neuron": [
                    10,
                    20,
                    40
                ],
                "resnet_dt": false,
                "axis_neuron": 12,
                "seed": 1
            },
            "fitting_net": {
                "neuron": [
                    120,
                    120,
                    120
                ],
                "resnet_dt": true,
                "seed": 1
            }
        },
        "learning_rate": {
            "type": "exp",
            "start_lr": 0.001,
            "decay_steps": 100,
            "_comment3": "nope",
            "stop_lr": 0.0003584859224085419
        },
        "loss": {
            "start_pref_e": 0.02,
            "limit_pref_e": 2,
            "start_pref_f": 1000,
            "limit_pref_f": 1,
            "start_pref_v": 0.0,
            "limit_pref_v": 0.0
        },
        "training": {
            "stop_batch": 2000,
            "seed": 1,
            "disp_file": "lcurve.out",
            "disp_freq": 1000,
            "save_freq": 1000,
            "save_ckpt": "model.ckpt",
            "disp_training": true,
            "time_training": true,
            "profiling": false,
            "profiling_file": "timeline.json",
            "training_data": {
                "systems": [],
                "batch_size": 1
            }
        }
    },
    "model_devi_dt": 0.002,
    "model_devi_skip": 0,
    "model_devi_f_trust_lo": 0.05,
    "model_devi_f_trust_hi": 0.15,
    "model_devi_clean_traj": true,
    "model_devi_jobs": [
        {
            "sys_idx": [
                0
            ],
            "temps": [
                100
            ],
            "press": [
                1
            ],
            "trj_freq": 10,
            "nsteps": 300,
            "ensemble": "nvt",
            "_idx": "00"
        },
        {
            "sys_idx": [
                1
            ],
            "temps": [
                100
            ],
            "press": [
                1
            ],
            "trj_freq": 10,
            "nsteps": 3000,
            "ensemble": "nvt",
            "_idx": "01"
        }
    ],
    "fp_style": "cp2k",
    "shuffle_poscar": false,
    "fp_task_max": 20,
    "fp_task_min": 5,
    "external_input_path": "/data/ybzhuang/methane-dpgen/dpgen-tutorial-2020-08-23/dpgen-tutorial-mathane/cp2k_dpgen/template.inp"
}
```

### 2. 关键词概述

- `sys_batch_size` 必须和 `sys_configs` 的子列表数一致，它告诉 DP-GEN 在对第 i 套结构集做预测/偏差计算时，一次性要处理多少个结构。



## 1.2 `template.inp` 文件


### 1. 输入文件

上述 `param.json` 文件会调用该 `template.inp` 文件文件，基于cp2k进行DFT标注

```sh
#Basis setting
@SET SCALE_FACTOR 1.000
@SET NREPA 1
@SET NREPB 1
@SET NREPC 1
@SET CELL_A 10
@SET CELL_B 10
@SET CELL_C 10
@SET ANGLE_A 90.0
@SET ANGLE_B 90.0
@SET ANGLE_C 90.0
@SET COORDFILE coord.xyz
@SET CUTOFF 400
@SET JOBNAME DPGEN


&FORCE_EVAL
  METHOD QS
  STRESS_TENSOR ANALYTICAL
  &PRINT
    &FORCES ON
    &END FORCES
    &STRESS_TENSOR ON
    &END STRESS_TENSOR
  &END PRINT

  &DFT
    BASIS_SET_FILE_NAME BASIS_MOLOPT
    POTENTIAL_FILE_NAME GTH_POTENTIALS
      &MGRID
      	CUTOFF ${CUTOFF}
        REL_CUTOFF 60
      &END MGRID
      &QS
      	EPS_DEFAULT 1.0E-13
      &END QS
      &SCF
        SCF_GUESS RESTART
      	EPS_SCF 3.0E-7
      	MAX_SCF 50
      	&OUTER_SCF
          EPS_SCF 3.0E-7
          MAX_SCF 15
      	&END OUTER_SCF
     	&OT
          MINIMIZER  DIIS
          PRECONDITIONER FULL_SINGLE_INVERSE
        &END OT
      &END SCF
      &XC
########## This part is PBE ##########
    	&XC_FUNCTIONAL PBE
    	&END XC_FUNCTIONAL
########## This part is PBE ##########
      &END XC
########## This part controls the print information ##########
  &END DFT
  &SUBSYS
    &CELL
      ABC [angstrom]   ${CELL_A}*${SCALE_FACTOR} ${CELL_B}*${SCALE_FACTOR} ${CELL_C}*${SCALE_FACTOR}
      ALPHA_BETA_GAMMA ${ANGLE_A} ${ANGLE_B} ${ANGLE_C}
      MULTIPLE_UNIT_CELL ${NREPA} ${NREPB} ${NREPC}
    &END CELL
    &TOPOLOGY
      MULTIPLE_UNIT_CELL ${NREPA} ${NREPB} ${NREPC}
    &END TOPOLOGY
    &COORD
      @include ${COORDFILE}
    &END COORD
    &KIND H
      BASIS_SET DZVP-MOLOPT-SR-GTH
      POTENTIAL GTH-PBE-q1
    &END KIND
    &KIND C
      BASIS_SET DZVP-MOLOPT-SR-GTH
      POTENTIAL GTH-PBE-q4
    &END KIND
  &END SUBSYS
&END FORCE_EVAL

&GLOBAL
  PROJECT ${JOBNAME}
&END GLOBAL
```

- 在CP2K中，`PRINT_LEVEL` 的默认值是 `MEDIUM`，而 `RUN_TYPE` 的默认值是 `ENERGY_FORCE`。因此，上述cp2k inp 文件中无需显式指定。


### 2. dp-gen调用`cp2k.py`模块

- [dpgen/generator/lib/cp2k.py](https://github.com/deepmodeling/dpgen/blob/master/dpgen/generator/lib/cp2k.py)


在 DFT 标注阶段（使用`template.inp`模板），DeepMD-Gen 会调用 `dpgen/generator/lib/cp2k.py` 中的以下函数：

1. `make_cp2k_input_from_external(sys_data, exinput_path)`:

   - 这个函数是主要的入口点，当 `param.json` 中指定了 `external_input_path` 时，它会被调用。

   - 它的作用是读取 `external_input_path` 指定的模板文件（即你的 `template.inp`），然后根据 `sys_data`（包含体系的晶胞信息和原子坐标等）对其进行修改。

   - 它会找到 `template.inp` 中包含 ABC 的行，例如 `ABC [angstrom] ${CELL_A}*${SCALE_FACTOR} ${CELL_B}*${SCALE_FACTOR} ${CELL_C}*${SCALE_FACTOR}`。
然后，它会删除这一行，并插入实际的晶胞向量 `A, B, C`。


2. `make_cp2k_xyz(sys_data)`:

   - 这个函数在 `make_cp2k_input_from_external` 内部不会直接被调用来修改 `template.inp` 文件本身。

   - 然而，它会被调用以生成一个 `coord.xyz` 文件。`template.inp` 中有一行 `@include ${COORDFILE}`，其中 `${COORDFILE}` 通常会被设置为 `coord.xyz`。因此，虽然 `make_cp2k_xyz` 不直接修改 `template.inp`，但它生成的文件是 `template.inp` 依赖的。

3. 如果体系中包含不在 `template.inp` 中定义的元素，dpgen 会根据 `param.json` 中的 `type_map` 和 `mass_map` 来处理，并确保 CP2K 能够识别。

4. `PROJECT NAME (GLOBAL Block)`: 模板中的 `${JOBNAME}` 会被 dpgen 在实际运行 CP2K 时替换为当前任务的作业名。











## 2. `param_CH4_deepmd-kit-2.0.1.json`

```json
{
    "type_map": [
        "H",
        "C"
    ],
    "mass_map": [
        1,
        12
    ],
    "init_data_prefix": "./data",
    "init_data_sys": [
        "deepmd"
    ],
    "sys_configs": [
        [
            "./data/CH4.POSCAR.01x01x01/01.scale_pert/sys-0004-0001/scale-1.000/00000*/POSCAR"
        ],
        [
            "./data/CH4.POSCAR.01x01x01/01.scale_pert/sys-0004-0001/scale-1.000/00001*/POSCAR"
        ]
    ],
    "_comment1": " that's all ",
    "numb_models": 4,
    "default_training_param": {
        "model": {
            "type_map": [
                "H",
                "C"
            ],
            "descriptor": {
                "type": "se_a",
                "sel": [
                    16,
                    4
                ],
                "rcut_smth": 0.5,
                "rcut": 5.0,
                "neuron": [
                    25,
                    50,
                    100
                ],
                "resnet_dt": true,
                "axis_neuron": 12,
                "seed": 1
            },
            "fitting_net": {
                "neuron": [
                    120,
                    120,
                    120
                ],
                "resnet_dt": false,
                "seed": 1
            }
        },
        "learning_rate": {
            "type": "exp",
            "start_lr": 0.001,
            "decay_steps": 200
        },
        "loss": {
            "start_pref_e": 0.02,
            "limit_pref_e": 1,
            "start_pref_f": 1000,
            "limit_pref_f": 1,
            "start_pref_v": 0.0,
            "limit_pref_v": 0.0
        },
        "training": {
            "stop_batch": 40000,
            "_batch_size": 1,
            "disp_file": "lcurve.out",
            "disp_freq": 1000,
            "save_freq": 1000,
            "save_ckpt": "model.ckpt",
            "disp_training": true,
            "time_training": true,
            "profiling": false,
            "profiling_file": "timeline.json",
            "_comment2": "that's all"
        }
    },
    "model_devi_dt": 0.002,
    "model_devi_skip": 0,
    "model_devi_f_trust_lo": 0.02,
    "model_devi_f_trust_hi": 0.15,
    "model_devi_clean_traj": true,
    "model_devi_jobs": [
        {
            "sys_idx": [
                0
            ],
            "temps": [
                100
            ],
            "press": [
                1
            ],
            "trj_freq": 10,
            "nsteps": 2000,
            "ensemble": "nvt",
            "_idx": "00"
        },
        {
            "sys_idx": [
                1
            ],
            "temps": [
                100
            ],
            "press": [
                1
            ],
            "trj_freq": 10,
            "nsteps": 5000,
            "ensemble": "nvt",
            "_idx": "01"
        }
    ],
    "ratio_failed": 0.2,
    "fp_style": "cp2k",
    "shuffle_poscar": false,
    "fp_task_max": 30,
    "fp_task_min": 1,
    "user_fp_params": {
        "FORCE_EVAL": {
            "DFT": {
                "BASIS_SET_FILE_NAME": "BASIS_MOLOPT",
                "POTENTIAL_FILE_NAME": "GTH_POTENTIALS"
            },
            "SUBSYS": {
                "KIND": {
                    "_": [
                        "C",
                        "H"
                    ],
                    "POTENTIAL": [
                        "GTH-PBE-q4",
                        "GTH-PBE-q1"
                    ],
                    "BASIS_SET": [
                        "DZVP-MOLOPT-GTH",
                        "DZVP-MOLOPT-GTH"
                    ]
                }
            }
        }
    }
}
```


参考资料：https://github.com/deepmodeling/dpgen/tree/master/examples/run/dp2.x-lammps-cp2k





# 4. dp-gen 输入文件

## 1. 官方上手案例/甲烷/vasp


1. 文件下载地址

- https://dp-public.oss-cn-beijing.aliyuncs.com/community/dpgen_example.tar.xz
- [2.2. Hands-on tutorial for DP-GEN (v0.10.6)](https://tutorials.deepmodeling.com/en/latest/Tutorials/DP-GEN/learnDoc/DP-GEN_handson.html)


2. 项目文件夹

```
├── init
    ├── CH4.POSCAR
    ├── CH4.POSCAR.01x01x01
        ├── 00.place_ele
        ├── 01.scale_pert
        ├── 02.md
        └── param.json
    ├── INCAR_methane.md
    ├── INCAR_methane.rlx
    └── param.json
└── run
    ├── INCAR_methane
    ├── POTCAR_C
    ├── POTCAR_H
    ├── machine.json
    └── param.json
```

- 文件夹 `init` 包含由 AIMD 模拟生成的初始数据。
  - 文件夹 `CH4.POSCAR.01x01x01` 包含由 DP-GEN `init_bulk` 过程生成的文件。
  - `INCAR_*` 和 `CH4.POSCAR` 是 VASP 的标准 INCAR 和 POSCAR 文件。
  - `param.json` 用于指定 DP-GEN `init_bulk` 过程的详细设置。

- 文件夹 `run` 包含运行过程的输入文件。
  - `param.json` 是当前任务中 DP-GEN 的设置文件。
  - `machine.json` 是一个任务分配器，用于设置机器环境和资源需求。
  - `INCAR*` 和 `POTCAR*` 是 VASP 软件包的输入文件，所有第一性原理计算共享与 `param.json` 中设置的相同参数。


### 1. 项目文件结构

```
目录树结构 (dpgen_example) 深度 20：

├── init
    ├── CH4.POSCAR
    ├── CH4.POSCAR.01x01x01
        ├── 00.place_ele
            ├── .ipynb_checkpoints
                └── d8688a0776ce3329aa788ff1aabb5ffa780b6727-checkpoint.sub
            ├── INCAR
            ├── POSCAR
            ├── POSCAR.copied
            ├── POTCAR
            ├── d8688a0776ce3329aa788ff1aabb5ffa780b6727.sub
            ├── d8688a0776ce3329aa788ff1aabb5ffa780b6727.zip
            ├── d8688a0776ce3329aa788ff1aabb5ffa780b6727_back.zip
            └── sys-0004-0001
                ├── CONTCAR
                ├── INCAR
                ├── OUTCAR
                ├── POSCAR
                └── POTCAR
        ├── 01.scale_pert
            └── sys-0004-0001
                └── scale-1.000
                    ├── 000000
                        └── POSCAR
                    ├── 000001
                        └── POSCAR
                    ├── ......
                    ├── 000030
                        └── POSCAR
                    └── POSCAR
        ├── 02.md
            ├── 0fd742e8f355f84ebc050a450f6f446e6c3348e6.sub
            ├── 0fd742e8f355f84ebc050a450f6f446e6c3348e6.zip
            ├── 46f1ea7caa9e0511b1c58e535d211a60c1ad1d37.sub
            ├── 46f1ea7caa9e0511b1c58e535d211a60c1ad1d37.zip
            ├── 5186b2ab1c6e0cc129ebf6e08625b5c1c275545e.sub
            ├── 5186b2ab1c6e0cc129ebf6e08625b5c1c275545e.zip
            ├── 590535ad8d57e72e15471a5aeba11f5986e6433f.sub
            ├── 590535ad8d57e72e15471a5aeba11f5986e6433f.zip
            ├── 7d58e62434f1a0a776e1eea452868d8903210271.sub
            ├── 7d58e62434f1a0a776e1eea452868d8903210271.zip
            ├── INCAR
            ├── POTCAR
            ├── e751723d53f29de07db52df91fb8af51335ad80f.sub
            ├── e751723d53f29de07db52df91fb8af51335ad80f.zip
            ├── e751723d53f29de07db52df91fb8af51335ad80f_back.zip
            ├── f0486f5b2b63aac8c054c1ad1b2dea34b6bd456d.sub
            ├── f0486f5b2b63aac8c054c1ad1b2dea34b6bd456d.zip
            └── sys-0004-0001
                ├── deepmd
                    ├── box.raw
                    ├── coord.raw
                    ├── energy.raw
                    ├── force.raw
                    ├── set.000
                        ├── box.npy
                        ├── coord.npy
                        ├── energy.npy
                        ├── force.npy
                        └── virial.npy
                    ├── type.raw
                    ├── type_map.raw
                    └── virial.raw
                └── scale-1.000
                    ├── 000000
                        ├── INCAR
                        ├── OUTCAR
                        ├── POSCAR
                        └── POTCAR
                    ├── ......
                     
                    └── 000030
                        ├── INCAR
                        ├── OUTCAR
                        ├── POSCAR
                        └── POTCAR
        └── param.json
    ├── INCAR_methane.md
    ├── INCAR_methane.rlx
    └── param.json
└── run
    ├── INCAR_methane
    ├── POTCAR_C
    ├── POTCAR_H
    ├── machine.json
    └── param.json
```



### 2. `param.json`文件

```json
{
     "type_map": ["H","C"],
     "mass_map": [1,12],
     "init_data_prefix": "../",
     "init_data_sys": ["init/CH4.POSCAR.01x01x01/02.md/sys-0004-0001/deepmd"],
     "sys_configs_prefix": "../",
     "sys_configs": [
         ["init/CH4.POSCAR.01x01x01/01.scale_pert/sys-0004-0001/scale-1.000/00000*/POSCAR"],
         ["init/CH4.POSCAR.01x01x01/01.scale_pert/sys-0004-0001/scale-1.000/00001*/POSCAR"]
     ],
     "_comment": " that's all ",
     "numb_models": 4,
     "default_training_param": {
         "model": {
             "type_map": ["H","C"],
             "descriptor": {
                 "type": "se_a",
                 "sel": [16,4],
                 "rcut_smth": 0.5,
                 "rcut": 5.0,
                 "neuron": [120,120,120],
                 "resnet_dt": true,
                 "axis_neuron": 12,
                 "seed": 1
             },
             "fitting_net": {
                 "neuron": [25,50,100],
                 "resnet_dt": false,
                 "seed": 1
             }
         },
         "learning_rate": {
             "type": "exp",
             "start_lr": 0.001,
             "decay_steps": 5000
         },
         "loss": {
             "start_pref_e": 0.02,
             "limit_pref_e": 2,
             "start_pref_f": 1000,
             "limit_pref_f": 1,
             "start_pref_v": 0.0,
             "limit_pref_v": 0.0
         },
         "training": {
             "stop_batch": 2000,
             "disp_file": "lcurve.out",
             "disp_freq": 1000,
             "numb_test": 4,
             "save_freq": 1000,
             "save_ckpt": "model.ckpt",
             "disp_training": true,
             "time_training": true,
             "profiling": false,
             "profiling_file": "timeline.json",
             "_comment": "that's all"
         }
     },
     "model_devi_dt": 0.002,
     "model_devi_skip": 0,
     "model_devi_f_trust_lo": 0.05,
     "model_devi_f_trust_hi": 0.15,
     "model_devi_e_trust_lo": 10000000000.0,
     "model_devi_e_trust_hi": 10000000000.0,
     "model_devi_clean_traj": true,
     "model_devi_jobs": [
         {"sys_idx": [0],"temps": [100],"press": [1.0],"trj_freq": 10,"nsteps": 300,"ensemble": "nvt","_idx": "00"},
         {"sys_idx": [1],"temps": [100],"press": [1.0],"trj_freq": 10,"nsteps": 3000,"ensemble": "nvt","_idx": "01"}
     ],
     "fp_style": "vasp",
     "shuffle_poscar": false,
     "fp_task_max": 20,
     "fp_task_min": 5,
     "fp_pp_path": "./",
     "fp_pp_files": ["POTCAR_H","POTCAR_C"],
     "fp_incar": "./INCAR_methane"
}
```

- `sys_configs[0]` 通配符下的所有 POSCAR 文件都会被用于探索。

- `model_devi_jobs[0]` 任务会为 `sys_configs[0]` 中匹配到的每个 POSCAR 文件运行一条独立的 MD 轨迹，而不是只选用一个 POSCAR 文件。

- 如果 `sys_configs[0]` 匹配到 N 个 POSCAR 文件，则 `model_devi_jobs[0]` 将生成 N 条独立的轨迹，每条轨迹运行 300 步。






### 3. `machine.json`文件

```json
{
	"api_version": "1.0",
	"deepmd_version": "2.0.1",
	"train" :[
		{
			"command": "dp",
			"machine": {
				"batch_type": "Shell",
				"context_type": "local",
				"local_root" : "./",
				"remote_root": "/home/ecust/lws"
			},
			"resources": {
				"number_node": 1,
				"cpu_per_node": 4,
				"gpu_per_node": 1,
				"group_size": 1
			}
		}
	],
	"model_devi":[
		{
			"command": "mpirun -n 4 lmpdplws -i input.lammps",
			"machine": {
				"batch_type": "Shell",
				"context_type": "local",
				"local_root" : "./",
				"remote_root": "/home/ecust/lws"
			},
			"resources": {
				"number_node": 1,
				"cpu_per_node": 4,
				"gpu_per_node": 1,
				"group_size": 5
			}
		}
	],
	"fp":[
		{
			"command": "mpirun -n 4 vasplws",
			"machine": {
				"batch_type": "Shell",
				"context_type": "local",
				"local_root" : "./",
				"remote_root": "/home/ecust/lws"
			},
			"resources": {
				"number_node": 1,
				"cpu_per_node": 4,
				"gpu_per_node": 1,
				"group_size": 125
			}
		}
	]
}
```





# 5. H2O体系/cp2k

- H2O体系，基于CP2K的DFT标注

### 1. `param.json`文件

```json
{
     "type_map": ["H"," O"],    # 初始数据集中所包含的元素，顺序与npy数据中的一样即可
     "mass_map": [1,16],        # 元素的相对原子质量
     "init_data_prefix": "../", # 初始数据集路径中的前缀
     "init_data_sys": ["00data/training_data/H2O1"  # 初始数据集路径除前缀后的部分。所以我的初始数据集路径为："../00data/training_data/H2O1"
],
     "sys_configs_prefix": "../",       # 用于动力学模拟的结构种子路径中的前缀
     "sys_configs": [
	["00data/initial_structure/1/*"]    # 用于动力学模拟的结构种子路径除前缀后的部分
     ],
     "_comment": " that's all ",
     "numb_models": 4,                  # 训练的DP势数量
     "default_training_param": {
         "model": {
             "type_map": ["H","O"],     # 体系元素种类
             "descriptor": {
                 "type": "se_e2_a",     
                 "sel": [200,100],      # 截断半径内可能包含的相应元素的原子数最大值
                 "rcut_smth": 0.5,      # 开始平滑处理的距离
                 "rcut":6.0,            # 截断半径
                 "neuron": [20,40,80],
                 "resnet_dt": false,
                 "axis_neuron": 12,
                 "seed": 1
             },
             "fitting_net": {
                 "neuron": [150,150,150],
                 "resnet_dt": true,
                 "seed": 1
             }
         },
         "learning_rate": {
             "type": "exp",
             "start_lr": 0.001,
	     "stop_lr":	3.51e-8,
             "decay_steps": 1000
         },
         "loss": {
             "start_pref_e": 0.02,
             "limit_pref_e": 2,
             "start_pref_f": 1000,
             "limit_pref_f": 1,
             "start_pref_v": 0.0,
             "limit_pref_v": 0.0
         },
         "training": {
             "stop_batch": 200000,
             "disp_file": "lcurve.out",
             "disp_freq": 1000,
             "numb_test": 4,
             "save_freq": 1000,
             "save_ckpt": "model.ckpt",
             "disp_training": true,
             "time_training": true,
             "profiling": false,
             "profiling_file": "timeline.json",
             "_comment": "that's all"
         }
     },
     "model_devi_dt": 0.0005,
     "model_devi_skip": 0,
     "model_devi_f_trust_lo": 0.5,
     "model_devi_f_trust_hi": 0.7,
     "model_devi_clean_traj": false,
     "model_devi_jobs": [
	{"sys_idx": [0],"temps": [350],"press": [1.0],"trj_freq": 10,"nsteps": 300,"ensemble": "nvt","_idx": "00"}
     ],
    "fp_style": "cp2k",
    "shuffle_poscar": false,
    "fp_task_max": 200,
    "fp_task_min": 0,
    "fp_pp_path": "/public/home/yaoshilong/bin/CP2K/cp2k-2024.2/data",
    "fp_pp_files": [],
    "external_input_path": "/public/home/yaoshilong/task2/2/2DPGEN/01run/template_point.inp"
}
```

参考资料：[基于CP2K的DP-GEN使用流程](https://zhuanlan.zhihu.com/p/9166088047)




# 6. Pt-H2O界面/cp2k

### 1. `param.json`文件




```json
{ 
    "type_map": [        
        "O", 
        "H",
        "Pt"
    ], 
    "mass_map": [ 
        15.999,
        1.0079,
        195.08
    ], 
    "_comment": " atoms in your systems ",
    "init_data_prefix": "/data/kmr/edl/pzc/hydroxide/ml_potential/pt-oh", 
    "init_data_sys": [
        "init/system-000","init/system-001"
    ], 
    "_comment": " path of training set ",
    "init_batch_size": [
        1,1
    ], 
    "sys_configs": [
        ["/data/kmr/edl/pzc/hydroxide/ml_potential/pt-oh/init/configs/POSCAR_0[0-9]"],
        ["/data/kmr/edl/pzc/hydroxide/ml_potential/pt-oh/init/configs/POSCAR_1[0-9]"]
    ], 
    "_comment": " path of initial structure for sampling ",
    "sys_batch_size": [
        1,1
    ], 


      "numb_models": 4, 
      "_comment": " number of NNP for model deviation ",
      "train_param": "input.json", 
      "_comment": " name of automatically generated input file for DPMD ",
      "default_training_param": {
          "model": {
          "descriptor": {
          "type": "se_a",
    "_comment": "could be bigger than the number of atoms of the very element",
          "sel": [68, 136, 64], 
          "rcut_smth": 0.50, 
          "rcut": 5.00, 
          "neuron": [25, 50, 100], 
          "resnet_dt": false, 
          "axis_neuron": 16,
          "seed": 1
          },
          "fitting_net": {
          "n_neuron": [240, 240, 240], 
          "resnet_dt": true, 
          "seed": 1
          }},
          "learning_rate": {
          "type": "exp",
          "start_lr": 0.005, 
          "decay_steps": 2000,
          "_comment": "last 20000 or 400000", 
          "decay_rate": 0.95
          },
          "loss": {
          "start_pref_e": 0.02, 
          "limit_pref_e": 1, 
          "start_pref_f": 1000, 
          "limit_pref_f": 1, 
          "start_pref_v": 0, 
          "limit_pref_v": 0
          },
          "training": {
          "systems": [ ], 
          "set_prefix": "set", 
          "stop_batch": 400000, 
          "batch_size": 1, 
          "seed": 1,
          "disp_file": "lcurve.out", 
          "disp_freq": 100, 
          "numb_test": 4, 
          "save_freq": 1000, 
          "save_ckpt": "model.ckpt", 
          "load_ckpt": "model.ckpt", 
          "disp_training": true, 
          "time_training": true, 
          "profiling": false, 
          "profiling_file": "timeline.json"
          }},
      "_comment": "modify according your systems!", 



    "model_devi_dt":            0.0005,
    "_comment": "model_devi_dt: Timesteps for MD. Consistent with DFTMD!",
    "model_devi_skip":          0,
    "_comment": "model_devi_skip: the first x frames of the recorded frames",
    "model_devi_f_trust_lo":    0.075,
    "model_devi_f_trust_hi":    0.10,
    "_comment": "modify according to the error distribution of system",
    "model_devi_e_trust_lo":    1e10,
    "model_devi_e_trust_hi":    1e10,
    "model_devi_clean_traj":    false,
    "model_devi_jobs": [
    {"temps": [300,400],"sys_idx": [0,1],"trj_freq": 10,"nsteps":  2000,"ensemble": "nvt","_idx": 0},
    {"temps": [300,400],"sys_idx": [0,1],"trj_freq": 10,"nsteps":  2000,"ensemble": "nvt","_idx": 1}
    ],
    "_comment": "sys_idx should correspond to sys_configs in the beginning",
    "_comment": "add the _idx step by step",
    "_comment": "modify nsteps and sys_idx based on model deviation accuracy",



    "fp_style":     "cp2k",
    "shuffle_poscar":   false,
    "fp_task_max":  200,
    "_comment":         "the maximum number of stcs to calc.",
    "fp_task_min":  5,
    "fp_pp_path":   ".",
    "fp_pp_files":  [],
    "_comment":"the maximum number of stcs to calc.",
     "_comment": "fp_params: modify according your systems!",
    "fp_params": {
        "FORCE_EVAL":{
            "DFT":{
                "BASIS_SET_FILE_NAME": "/data/kmr/BASIC_SET/BASIS_MOLOPT",
                "POTENTIAL_FILE_NAME": "/data/kmr/BASIC_SET/GTH_POTENTIALS",
                "MGRID":{
                    "CUTOFF": 400
                },
                "QS":{
                    "EPS_DEFAULT": 1.0E-13
                },
                "SCF":{
                    "SCF_GUESS": "ATOMIC",
                    "EPS_SCF": 1.0E-6,
                    "MAX_SCF": 500,
                    "ADDED_MOS": 500,
                    "CHOLESKY": "INVERSE",
                    "SMEAR":{"ON"
                        "METHOD": "FERMI_DIRAC",
                        "ELECTRONIC_TEMPERATURE": 300
                    },
                    "DIAGONALIZATION":{
                        "ALGORITHM": "STANDARD"
                    },
                    "MIXING":{
                               "METHOD": "BROYDEN_MIXING",
                               "ALPHA":   0.3,
                               "BETA":    1.5,
                               "NBROYDEN":  14
                    }
                },
                "XC":{
                        "XC_FUNCTIONAL":{"_": "PBE"},
                        "XC_GRID":{
                                "XC_SMOOTH_RHO": "NN50",
                                "XC_DERIV": "NN50_SMOOTH"
                        },
                        "vdW_POTENTIAL":{
                                "DISPERSION_FUNCTIONAL": "PAIR_POTENTIAL",
                                "PAIR_POTENTIAL":{
                                        "TYPE": "DFTD3",
                                        "PARAMETER_FILE_NAME": "/data/kmr/BASIC_SET/dftd3.dat",
                                        "REFERENCE_FUNCTIONAL": "PBE"
                                }
                        }
                }
           },
            "SUBSYS":{
                        "KIND":{
                                "_": ["O", "H","Pt"],
                                "POTENTIAL": ["GTH-PBE-q6", "GTH-PBE-q1","GTH-PBE-q10"],
                                "BASIS_SET": ["DZVP-MOLOPT-SR-GTH", "DZVP-MOLOPT-SR-GTH","DZVP-A5-Q10-323-MOL-T1-DERIVED_SET-1"]
                        }
            }
        }
    }
}
```


### 2. `machine.json`文件

```json
{
  "api_version": "1.0",
  "train": [
    {
      "command": "dp",
      "machine": {
        "batch_type": "Slurm",
        "context_type": "LocalContext",
        "local_root": "./",
        "remote_root": "/data/tom/dprun/train",
      },
      "resources": {
        "number_node": 1,
        "cpu_per_node": 1,
        "gpu_per_node": 1,
        "queue_name": "gpu3",
        "group_size": 1,
        "module_list": [
          "deepmd/2.0"
        ]
      }
    }
  ],
  "model_devi":[
    {
      "command": "lmp_mpi",
      "machine":{
        "batch_type": "Slurm",
        "context_type": "SSHContext",
        "local_root": "./",
        "remote_root": "/data/jerry/dprun/md",
        "remote_profile": {
          "hostname": "198.76.54.32",
          "username": "jerry",
          "port": 6666
        }
      },
      "resources": {
        "number_node": 1,
        "cpu_per_node": 1,
        "gpu_per_node": 1,
        "queue_name": "gpu2",
        "group_size": 5,
        "kwargs": {
          "custom_gpu_line": [
            "#SBATCH --gres=gpu:1g.10gb:1"
          ]
        },
        "strategy": {"if_cuda_multi_devices": false},
        "para_deg": 2,
        "module_list": [
          "deepmd/2.1"
        ],
        "source_list": []
      }
    }
  ],
  "fp":[
    {
      "command": "mpiexec.hydra -genvall cp2k.popt input.inp",
      "machine":{
        "batch_type": "Slurm",
        "context_type": "SSHContext",
        "local_root": "./",
        "remote_root": "/data/jerry/dprun/fp",
        "remote_profile": {
          "hostname": "198.76.54.32",
          "username": "jerry",
          "port": 6666
        }
      },
      "resources": {
        "number_node": 2,
        "cpu_per_node": 32,
        "gpu_per_node": 0,
        "queue_name": "c53-medium",
        "group_size": 10,
        "module_list": [
          "intel/17.5.239",
          "mpi/intel/2017.5.239",
          "gcc/5.5.0"
          "cp2k/7.1"
        ]
      }
    }
  ]
}
```


参考资料：[DP-GEN使用入门](https://wiki.cheng-group.net/en/wiki/software_usage/DP-GEN/)




# 7. Slurm与dpgen

## 1. cp2k/lammps/deepmd-kit超算提交脚本

### 1. cp2k

cp2k 超算提交脚本如下：

```sh
#!/bin/bash
#SBATCH -p amd_256
#SBATCH -N 1
#SBATCH -n 64
#export OMP_NUM_THREADS=1
source /public21/soft/modules/module.sh
module load gcc/7.3.0-kd
module load  mpi/openmpi/4.1.1-gcc7.3.0
export PATH=/public21/soft/cp2k/8.1/exe/local:$PATH
source /public21/soft/cp2k/8.1/tools/toolchain/install/setup
export CP2K_DATA_DIR=/public21/soft/cp2k/8.1/data
mpirun cp2k.psmp -i OT.inp -o tem.out
```

### 2. lammps

lammps 超算提交脚本如下：

```sh
#!/bin/bash
#SBATCH -p amd_256
#SBATCH -N 1
#SBATCH -c 64

# OpenMP 线程数
export OMP_NUM_THREADS=8

# TensorFlow 并行度（DeepMD-kit v2.2.1 只认这俩）
# export TF_INTRA_OP_PARALLELISM_THREADS=8
# export TF_INTER_OP_PARALLELISM_THREADS=8

# （可选）同时保留新版本别名
export DP_INTRA_OP_PARALLELISM_THREADS=8
export DP_INTER_OP_PARALLELISM_THREADS=8

source /public21/home/sc90511/deepmd-kit/bin/activate
lmp -i in.lammps  > lmp.out 2>&1
```


### 3. deepmd-kit

deepmd-kit超算提交脚本如下：

```sh
#!/bin/bash
#SBATCH -p amd_256
#SBATCH -N 1
#SBATCH -c 64

# OpenMP 线程数
export OMP_NUM_THREADS=8

# TensorFlow 并行度（DeepMD-kit v2.2.1 只认这俩）
# export TF_INTRA_OP_PARALLELISM_THREADS=8
# export TF_INTER_OP_PARALLELISM_THREADS=8

# （可选）同时保留新版本别名
export DP_INTRA_OP_PARALLELISM_THREADS=8
export DP_INTER_OP_PARALLELISM_THREADS=8

source /public21/home/sc90511/deepmd-kit/bin/activate
dp train input.json  > train.out 2>&1
```


### 4. Slurm 指令详解

1. `#!/bin/bash`:
   - 这被称为 Shebang。它告诉操作系统应该使用哪个解释器来执行此脚本。在这种情况下，它指定脚本应使用 /bin/bash 来运行，意味着这是一个 Bash shell 脚本。
   - 尽管在你的特定示例中它被 #SBATCH 注释掉了（实际上它应该在脚本的第一行，且不带 #），但在任何 shell 脚本的开头都加上它是一个好习惯，以确保其正确执行。
   - 在 Slurm 的上下文中，虽然 Slurm 本身可能会调用一个 shell 来执行脚本，但这一行明确定义了脚本内容的 shell。

2. `#SBATCH -p amd_256`:
   - 这是一条 Slurm 指令，用于指定你的作业应该运行的分区 (partition) 或队列。amd_256 是你的超算上某个特定计算分区的名称。
   - 不同的分区通常具有不同的硬件配置（例如，CPU 类型、内存、互连网络）或使用策略。通过指定它，你是在告诉 Slurm 将你的作业提交到 amd_256 分区。

3. `#SBATCH -N 1`:
   - 这条指令告诉 Slurm 为你的作业请求 1 个计算节点。在 HPC 中，一个节点是包含一个或多个 CPU 和内存的独立物理机器。

4. `#SBATCH -n 64`: 这条指令指定了你的作业将使用的总任务数（或 MPI 进程数），这些任务将分布在所有请求的节点上。
   - 在你的例子中，你请求了 64 个任务。由于你请求了 1 个节点 (-N 1)，这意味着所有 64 个任务都将在该单个节点上运行。这对于像 CP2K 这样的并行计算应用程序至关重要，因为它决定了将启动多少个并行进程。

5. `#export OMP_NUM_THREADS=1`:
   - 这行以单个 # 字符注释掉，这是一个标准的 shell 注释字符。它是一个 shell 命令，而不是 Slurm 指令。如果它没有被注释掉，它会设置 OpenMP 线程数的环境变量为 1。
   - OpenMP 是另一种并行编程范式，通常用于单节点内的共享内存并行。设置 `OMP_NUM_THREADS=1` 意味着你的 cp2k.psmp 程序中任何支持 OpenMP 的部分将只使用一个线程。
   - 在你当前的设置中，使用了 mpirun 并且 -n 64 暗示了 MPI 并行，明确设置 `OMP_NUM_THREADS=1` 通常是为了确保 MPI 任务不会也尝试派生多个 OpenMP 线程，这可能导致 CPU 核心过度订阅和性能下降。由于它被注释掉了，所以它目前没有作用。然而，它的存在表明有人可能考虑过这个参数，或者它可能与其他运行相关。




## 2. 超算 `machine.json`

### 1. gpu分区远程提交到cpu分区

- 超算gpu分区远程提交到cpu分区计算

```json
{
  "api_version": "1.0",
  "deepmd_version": "2.1.0",
  "train": [
    {
      "command": "dp",
      "machine": {
        "batch_type": "Slurm",
        "context_type": "local",
        "local_root": "./",
        "remote_root": "./work"
      },
      "resources": {
        "number_node": 1,
        "cpu_per_node": 10,
        "gpu_per_node": 1,
        "queue_name": "gpu",
        "group_size": 20,
        "source_list": [
          "/data/home/scy0002/run/yyg/dpwork/colombo-academy-tutorials/DP-GEN/dp.sh"
        ]
      }
    }
  ],
  "model_devi": [
    {
      "command": "lmp -i input.lammps -v restart 0",
      "machine": {
        "batch_type": "Slurm",
        "context_type": "local",
        "local_root": "./",
        "remote_root": "./work"
      },
      "resources": {
        "number_node": 1,
        "cpu_per_node": 10,
        "gpu_per_node": 1,
        "queue_name": "gpu",
        "group_size": 20,
        "source_list": [
          "/data/home/scy0002/run/yyg/dpwork/colombo-academy-tutorials/DP-GEN/dp.sh"
        ]
      }
    }
  ],
  "fp": [
    {
      "command": "mpirun -n 64 vasp_std",
      "machine": {
        "batch_type": "Slurm",
        "context_type": "SSHContext",
        "local_root": "./",
        "remote_root": "/public1/home/scb6681/yyg/dpwork",
        "remote_profile": {
          "username": "scb6681@BSCC-A6",
          "hostname": "ssh.cn-zhongwei-cstnet.paracloud.com",
          "port": 22,
          "key_filename": "/data/home/scy0002/run/yyg/dpwork/colombo-academy-tutorials/DP-GEN/idea/id_ecdsa",
          "tar_compress": true
        }
      },
      "resources": {
        "number_node": 1,
        "cpu_per_node": 64,
        "gpu_per_node": 0,
        "queue_name": "amd_512",
        "group_size": 5,
        "source_list": [
          "/public1/home/scb6681/yyg/vasp.sh"
        ]
      }
    }
  ]
}
```



# 8. LiGePS/vasp

### 1. `param.json`



### 2. `machine.json`

```json
{
  "api_version": "1.0",
  "deepmd_version": "2.2.7",
  "train": [
    {
      "command": "dp",
      "machine": {
        "batch_type": "Slurm",
        "context_type": "local",
        "local_root": "./",
        "remote_root": "/home/liujc/deepmd/DeepMD-kit/LiGePS/dpgen/work"
      },
      "resources": {
        "number_node": 1,
        "cpu_per_node": 13,
        "gpu_per_node": 1,
        "queue_name": "gpu",
        "custom_flags": [
          "#SBATCH -J dp"
        ],
        "group_size": 1,
        "source_list": [],
        "module_list": [
          "conda/deepmd-2.2.7-gpu"
        ]
      }
    }
  ],
  "model_devi": [
    {
      "command": "LAMMPS_PLUGIN_PATH=/opt/pub/toolkits/anaconda3/envs/deepmd-2.2.7-gpu/lib/deepmd_lmp lmp_mpi",
      "machine": {
        "batch_type": "Slurm",
        "context_type": "local",
        "local_root": "./",
        "remote_root": "/home/liujc/deepmd/DeepMD-kit/LiGePS/dpgen/work"
      },
      "resources": {
        "number_node": 1,
        "cpu_per_node": 13,
        "gpu_per_node": 1,
        "queue_name": "gpu",
        "custom_flags": [
          "#SBATCH -J lmp"
        ],
        "group_size": 1,
        "source_list": [],
        "module_list": [
          "conda/deepmd-2.2.7-gpu"
        ]
      }
    }
  ],
  "fp": [
    {
      "command": "mpirun vasp_gam",
      "machine": {
        "batch_type": "Slurm",
        "context_type": "local",
        "local_root": "./",
        "remote_root": "/home/liujc/deepmd/DeepMD-kit/LiGePS/dpgen/work"
      },
      "resources": {
        "number_node": 1,
        "cpu_per_node": 64,
        "gpu_per_node": 0,
        "queue_name": "64cores",
        "custom_flags": [
          "#SBATCH -n 64",
          "#SBATCH -J fp"
        ],
        "group_size": 1,
        "source_list": [],
        "module_list": [
          "VASP/6.3.2-gzbuild-intel_8300"
        ]
      }
    }
  ]
}
```






# 参考资料







