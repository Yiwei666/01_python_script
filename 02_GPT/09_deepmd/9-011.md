# cp2kdataæºç åˆ†æ

# 1. æ¦‚è¿°

è¿™ä¸ª`cp2kdata`æ’ä»¶é€šè¿‡å‡ ä¸ªå…³é”®æ¨¡å—çš„åä½œï¼Œå®ç°ä»CP2K AIMDï¼ˆä»å¤´ç®—åˆ†å­åŠ¨åŠ›å­¦ï¼‰è¾“å‡ºæ–‡ä»¶ä¸­æå–èƒ½é‡ã€åŸå­åæ ‡ã€åŠ›å’Œæ™¶èƒç­‰ä¿¡æ¯ï¼Œå¹¶æœ€ç»ˆæœåŠ¡äº`deepmd-kit`è¿›è¡Œæ·±åº¦å­¦ä¹ åŠ¿èƒ½è®­ç»ƒï¼ˆé€šè¿‡`dpdata`åº“ä½œä¸ºæ¡¥æ¢ï¼‰ã€‚

æ ¸å¿ƒåŠŸèƒ½ç›¸å…³çš„æºä»£ç éƒ¨åˆ†ä¸»è¦åŒ…æ‹¬ï¼š

1.  **`cp2kdata/dpdata_plugin.py`**: è¿™æ˜¯ä¸`dpdata`ï¼ˆä»¥åŠé—´æ¥ä¸`deepmd-kit`ï¼‰ç›´æ¥äº¤äº’çš„æ¥å£ã€‚
2.  **`cp2kdata/output.py`**: è¿™æ˜¯å®é™…è§£æCP2Kè¾“å‡ºæ–‡ä»¶çš„æ ¸å¿ƒç±»`Cp2kOutput`ã€‚
3.  **`cp2kdata/block_parser/`ç›®å½•ä¸‹çš„æ¨¡å—**: è¿™äº›æ¨¡å—åŒ…å«äº†ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ä»æ–‡æœ¬è¾“å‡ºä¸­æå–ç‰¹å®šæ•°æ®å—ï¼ˆå¦‚èƒ½é‡ã€åŠ›ã€åæ ‡ã€æ™¶èƒç­‰ï¼‰çš„å‡½æ•°ã€‚

ä¸‹é¢æ˜¯å…·ä½“å®ç°åŠŸèƒ½çš„è§£æï¼š

---
## 1. `cp2kdata/dpdata_plugin.py` æ˜¯ `dpdata` æ¥å£

è¿™ä¸ªæ–‡ä»¶å®šä¹‰äº†`dpdata`å¯ä»¥è¯†åˆ«å’Œè°ƒç”¨çš„æ ¼å¼åŒ–ç±»ã€‚å¯¹äºAIMDæ•°æ®æå–ï¼Œå…³é”®æ˜¯ `CP2KMDFormat` ç±»ã€‚

* **æ³¨å†Œæ ¼å¼**:
    ```python
    @Format.register("cp2k/aimd_output")
    @Format.register("cp2kdata/md")
    class CP2KMDFormat(Format):
        # ...
    ```
    è¿™ä½¿å¾—å½“ç”¨æˆ·åœ¨`dpdata`ä¸­æŒ‡å®šæ ¼å¼ä¸º "cp2k/aimd\_output" æˆ– "cp2kdata/md" æ—¶ï¼Œ`dpdata`ä¼šè°ƒç”¨è¿™ä¸ªç±»ã€‚

* **`from_labeled_system` æ–¹æ³•**: è¿™æ˜¯`dpdata`è°ƒç”¨ä»¥è¯»å–æ•°æ®çš„æ ¸å¿ƒæ–¹æ³•ã€‚
    ```python
    def from_labeled_system(self, file_name, restart: bool=None, **kwargs):
        # ...
        cp2kmd = Cp2kOutput(output_file=cp2k_output_name,
                              run_type="MD",
                              ensemble_type=ensemble_type,
                              path_prefix=path_prefix,
                              restart=restart
                              )
        # ...
        data = {}
        data['atom_names'], data['atom_numbs'], data["atom_types"] = get_uniq_atom_names_and_types(...)
        data['energies'] = cp2kmd.energies_list * AU_TO_EV
        data['cells'] = cells # cells come from cp2kmd.get_all_cells() or user input
        data['coords'] = cp2kmd.atomic_frames_list
        data['forces'] = cp2kmd.atomic_forces_list * AU_TO_EV/AU_TO_ANG
        if cp2kmd.has_stress():
            # ... virial calculation ...
            data['virials'] = cp2kmd.stress_tensor_list*volumes/EV_ANG_m3_TO_GPa
        # ...
        return data
    ```
    * **å®ä¾‹åŒ– `Cp2kOutput`**: é¦–å…ˆï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ª `Cp2kOutput` ç±»çš„å®ä¾‹ã€‚`Cp2kOutput` ç±»è´Ÿè´£å®é™…è§£æCP2Kçš„è¾“å‡ºæ–‡ä»¶ï¼ˆä¸»è¾“å‡ºæ–‡ä»¶ä»¥åŠå¯èƒ½çš„è¾…åŠ©æ–‡ä»¶å¦‚ `*.ener`, `*-pos-*.xyz`, `*-frc-*.xyz`, `*.cell`ï¼‰ã€‚
    * **è·å–æ•°æ®**: é€šè¿‡è°ƒç”¨ `cp2kmd` (å³ `Cp2kOutput` å®ä¾‹) çš„å„ç§æ–¹æ³•å’Œå±æ€§ï¼ˆå¦‚ `energies_list`, `atomic_frames_list`, `atomic_forces_list`, `get_all_cells`ï¼‰ï¼Œè·å–è§£æåçš„èƒ½é‡ã€åæ ‡ã€åŠ›ã€æ™¶èƒç­‰ä¿¡æ¯ã€‚
    * **å•ä½è½¬æ¢**: æ³¨æ„ä»£ç ä¸­ `AU_TO_EV` (Hartreeåˆ°eV) å’Œ `AU_TO_ANG` (Bohråˆ°Angstrom) çš„ä½¿ç”¨ã€‚CP2Kå†…éƒ¨å¸¸ç”¨åŸå­å•ä½ï¼Œè€Œ`deepmd-kit`é€šå¸¸éœ€è¦eVå’ŒAngstromä¸ºå•ä½çš„æ•°æ®ã€‚
    * **æ•°æ®ç»“æ„åŒ–**: å°†æå–å¹¶è½¬æ¢å•ä½åçš„æ•°æ®ç»„ç»‡æˆä¸€ä¸ªå­—å…¸ `data`ï¼Œè¿™ä¸ªå­—å…¸çš„é”®ï¼ˆå¦‚`'energies'`, `'coords'`, `'forces'`, `'cells'`ï¼‰æ˜¯`dpdata`æœŸæœ›çš„æ ‡å‡†æ ¼å¼ã€‚
    * **è¿”å›ç»™ `dpdata`**: `from_labeled_system` æ–¹æ³•è¿”å›è¿™ä¸ª`data`å­—å…¸ã€‚`dpdata`åº“æ¥æ”¶åˆ°è¿™ä¸ªå­—å…¸åï¼Œä¼šå°†å…¶å†…éƒ¨å¤„ç†å¹¶å¯ä»¥è¿›ä¸€æ­¥è½¬æ¢ä¸º`deepmd-kit`è®­ç»ƒæ‰€éœ€çš„NPYæ–‡ä»¶æ ¼å¼ï¼ˆä¾‹å¦‚ï¼Œä¿å­˜ä¸º `set.000/energy.npy`, `set.000/coord.npy`, `set.000/force.npy` ç­‰ï¼‰ã€‚

---
## 2. `cp2kdata/output.py` CP2K è¾“å‡ºè§£ææ ¸å¿ƒ

`Cp2kOutput` ç±»æ˜¯æ•°æ®æå–çš„â€œå·¥ä½œé©¬â€ã€‚

* **`__init__` æ–¹æ³•**:
    * æ¥æ”¶CP2Kä¸»è¾“å‡ºæ–‡ä»¶å (`output_file`)ã€è¿è¡Œç±»å‹ (`run_type`)ã€æ–‡ä»¶è·¯å¾„å‰ç¼€ (`path_prefix`) ç­‰å‚æ•°ã€‚
    * è°ƒç”¨ `parse_global_info` ç¡®å®šCP2Kçš„è¿è¡Œç±»å‹ã€‚
    * æ ¹æ®è¿è¡Œç±»å‹ï¼ˆåœ¨æ­¤åœºæ™¯ä¸‹æ˜¯ "MD"ï¼‰ï¼Œè°ƒç”¨ç›¸åº”çš„è§£ææ–¹æ³•ï¼Œå³ `self.parse_md()`ã€‚

* **`parse_md()` æ–¹æ³•**: è¿™æ˜¯ä¸“é—¨ä¸ºè§£æMDæ¨¡æ‹Ÿè¾“å‡ºè®¾è®¡çš„æ–¹æ³•ã€‚
    * **èƒ½é‡ (`self.energies_list`)**:
        * ä¼˜å…ˆå°è¯•ä» `*.ener` æ–‡ä»¶è§£æèƒ½é‡ (è°ƒç”¨ `block_parser.md_xyz.parse_md_ener`)ã€‚
        * å¦‚æœ `*.ener` æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½† `*-pos-*.xyz` æ–‡ä»¶å­˜åœ¨ï¼Œåˆ™ä»ä¸­è§£æèƒ½é‡ (è°ƒç”¨ `block_parser.md_xyz.parse_pos_xyz`)ã€‚
        * å¦‚æœä¸¤è€…éƒ½ä¸å­˜åœ¨ï¼Œåˆ™ä»ä¸»è¾“å‡ºæ–‡ä»¶è§£æèƒ½é‡ (è°ƒç”¨ `block_parser.energies.parse_energies_list`)ã€‚
    * **åæ ‡ (`self.atomic_frames_list`)**:
        * ä¸»è¦ä» `*-pos-*.xyz` æ–‡ä»¶è§£ææ¯ä¸€å¸§çš„åŸå­åæ ‡ (è°ƒç”¨ `block_parser.md_xyz.parse_pos_xyz`)ã€‚
    * **åŠ› (`self.atomic_forces_list`)**:
        * ä¼˜å…ˆå°è¯•ä» `*-frc-*.xyz` æ–‡ä»¶è§£æåŠ› (è°ƒç”¨ `block_parser.md_xyz.parse_frc_xyz`)ã€‚
        * å¦‚æœ `*-frc-*.xyz` æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä»ä¸»è¾“å‡ºæ–‡ä»¶è§£æåŠ› (è°ƒç”¨ `block_parser.forces.parse_atomic_forces_list`)ã€‚
    * **æ™¶èƒ (`self.all_cells`)**:
        * æ ¹æ®ç³»ç»¼ç±»å‹ï¼ˆå¦‚NVT, NPTï¼‰å’Œæ˜¯å¦å­˜åœ¨ `*.cell` æ–‡ä»¶ï¼Œé‡‡å–ä¸åŒç­–ç•¥ã€‚
        * å¦‚æœ `*.cell` æ–‡ä»¶å­˜åœ¨ï¼Œåˆ™ä»ä¸­è§£æ (è°ƒç”¨ `block_parser.md_xyz.parse_md_cell`)ã€‚
        * å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä»ä¸»è¾“å‡ºæ–‡ä»¶è§£æ (è°ƒç”¨ `block_parser.cells.parse_all_cells` è·å–åˆå§‹æ™¶èƒï¼Œ`block_parser.cells.parse_all_md_cells` è·å–MDè¿‡ç¨‹ä¸­çš„æ™¶èƒ)ã€‚
    * **å…¶ä»–ä¿¡æ¯**: è§£æåŸå­ç§ç±» (`self.atomic_kind`)ã€åˆå§‹åŸå­åæ ‡ (`self.init_atomic_coordinates`)ã€åŒ–å­¦ç¬¦å· (`self.chemical_symbols`) ç­‰ã€‚

---
## 3. `cp2kdata/block_parser/`  åº•å±‚æ–‡æœ¬è§£æ

è¿™äº›æ¨¡å—æä¾›äº†å…·ä½“çš„å‡½æ•°ï¼Œä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼ˆ`regex`æˆ–`re`ï¼‰ä»æ–‡æœ¬æ–‡ä»¶ä¸­å®šä½å’Œæå–æ•°æ®ã€‚

* **`block_parser/md_xyz.py`**:
    * `parse_md_ener()`: è¯»å– `.ener` æ–‡ä»¶ï¼Œé€šå¸¸æ¯è¡ŒåŒ…å«èƒ½é‡ã€‚
    * `parse_pos_xyz()`: è§£ææ ‡å‡†çš„XYZæ ¼å¼æ–‡ä»¶ï¼Œä½†CP2Kçš„ `*-pos-*.xyz` æ–‡ä»¶åœ¨æ³¨é‡Šè¡Œé€šå¸¸åŒ…å«èƒ½é‡ä¿¡æ¯ã€‚
    * `parse_frc_xyz()`: è§£æ `*-frc-*.xyz` æ–‡ä»¶ï¼Œæ ¼å¼ç±»ä¼¼XYZï¼Œä½†å€¼ä¸ºåŠ›ã€‚
    * `parse_md_cell()`: è¯»å– `PROJECTNAME-1.cell` æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æ¯ä¸€å¸§çš„æ™¶èƒçŸ¢é‡ã€‚

* **`block_parser/energies.py`**:
    * `parse_energies_list()`: ä½¿ç”¨ `ENERGIES_RE` æ­£åˆ™è¡¨è¾¾å¼åœ¨CP2Kä¸»è¾“å‡ºæ–‡ä»¶ä¸­æŸ¥æ‰¾åŒ…å« "ENERGY| Total FORCE\_EVAL ( QS ) energy" çš„è¡Œæ¥æå–æ€»èƒ½é‡ã€‚

* **`block_parser/forces.py`**:
    * `parse_atomic_forces_list()`: ä½¿ç”¨ `ATOMIC_FORCES_RE` æ­£åˆ™è¡¨è¾¾å¼åœ¨ä¸»è¾“å‡ºæ–‡ä»¶ä¸­æ‰¾åˆ° "ATOMIC FORCES in \[a.u.\]" å—æ¥æå–æ¯ä¸ªåŸå­çš„åŠ›ã€‚

* **`block_parser/cells.py`**:
    * `parse_all_cells()`: ä½¿ç”¨ `ALL_CELL_RE` æ­£åˆ™è¡¨è¾¾å¼æå–ä¸»è¾“å‡ºæ–‡ä»¶ä¸­çš„ "CELL| Vector a/b/c" å—æ¥è·å–æ™¶èƒçŸ¢é‡ã€‚
    * `parse_all_md_cells()`: ä½¿ç”¨ `ALL_MD_CELL_RE_V7` æˆ– `ALL_MD_CELL_RE_V2023`ï¼ˆæ ¹æ®CP2Kç‰ˆæœ¬ï¼‰ä»ä¸»è¾“å‡ºæ–‡ä»¶ä¸­çš„ "MD| Cell lengths \[bohr\]" å’Œ "MD| Cell angles \[deg\]" å—æå–MDè½¨è¿¹ä¸­çš„æ™¶èƒå‚æ•°ï¼Œå¹¶è½¬æ¢ä¸ºæ™¶èƒçŸ©é˜µã€‚

* **`block_parser/coordinates.py`**:
    * `parse_init_atomic_coordinates()`: ä»ä¸»è¾“å‡ºçš„ "MODULE QUICKSTEP: ATOMIC COORDINATES" å—è·å–åˆå§‹åŸå­åæ ‡å’Œç±»å‹ã€‚

* **`block_parser/atomic_kind.py`**:
    * `parse_atomic_kinds()`: ä»ä¸»è¾“å‡ºçš„ "Atomic kinds:" å—è·å–åŸå­ç§ç±»æ ‡ç­¾ã€‚

---
**æ€»ç»“å®ç°æµç¨‹**:

1.  ç”¨æˆ·é€šè¿‡`dpdata`æŒ‡å®šåŠ è½½CP2K AIMDæ•°æ®ã€‚
2.  `dpdata`æ ¹æ®æ³¨å†Œçš„æ ¼å¼ï¼Œè°ƒç”¨`cp2kdata.dpdata_plugin.CP2KMDFormat`çš„`from_labeled_system`æ–¹æ³•ã€‚
3.  `CP2KMDFormat`å®ä¾‹åŒ–`cp2kdata.output.Cp2kOutput`ã€‚
4.  `Cp2kOutput`åœ¨å…¶`parse_md`æ–¹æ³•ä¸­ï¼ŒæŒ‰ä¼˜å…ˆçº§ï¼ˆé€šå¸¸æ˜¯ä¸“ç”¨æ–‡ä»¶å¦‚`PROJECT-pos-1.xyz`ã€`PROJECT-frc-1.xyz`ã€`PROJECT-1.ener`ã€`PROJECT-1.cell`ä¼˜å…ˆï¼Œè‹¥æ— åˆ™ä»ä¸»è¾“å‡ºæ–‡ä»¶`*.out`ï¼‰è°ƒç”¨`block_parser`ä¸­çš„å„ä¸ªå‡½æ•°ã€‚
5.  `block_parser`ä¸­çš„å‡½æ•°ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è§£ææ–‡ä»¶å†…å®¹ï¼Œæå–åŸå§‹çš„èƒ½é‡ã€åæ ‡ã€åŠ›ã€æ™¶èƒç­‰æ•°æ®ã€‚
6.  `Cp2kOutput`æ”¶é›†è¿™äº›æ•°æ®å¹¶å­˜å‚¨ä¸ºè‡ªèº«çš„å±æ€§ã€‚
7.  `CP2KMDFormat`ä»`Cp2kOutput`å®ä¾‹è·å–è¿™äº›æ•°æ®ï¼Œè¿›è¡Œå¿…è¦çš„å•ä½è½¬æ¢ï¼ˆåŸå­å•ä½åˆ°eV/Angstromï¼‰ï¼Œå¹¶æ•´åˆæˆ`dpdata`æœŸæœ›çš„å­—å…¸æ ¼å¼ã€‚
8.  `dpdata`æ¥æ”¶æ­¤å­—å…¸ï¼Œå®Œæˆåç»­å¤„ç†ï¼Œå¦‚ç”Ÿæˆç”¨äº`deepmd-kit`è®­ç»ƒçš„NPYæ–‡ä»¶ã€‚

è¿™ç§åˆ†å±‚è®¾è®¡ä½¿å¾—ä»£ç æ¨¡å—åŒ–ï¼š`dpdata_plugin.py`è´Ÿè´£æ¥å£ï¼Œ`output.py`è´Ÿè´£ä»»åŠ¡åè°ƒå’Œé«˜çº§é€»è¾‘ï¼Œè€Œ`block_parser/`åˆ™ä¸“æ³¨äºåº•å±‚çš„æ–‡æœ¬è§£æç»†èŠ‚ã€‚





# 2. å·¥ä½œæµ

æ¢³ç†ä¸€ä¸‹ `cp2kdata` è¿™ä¸ªæ’ä»¶åœ¨å¤„ç† CP2K AIMDï¼ˆä»å¤´ç®—åˆ†å­åŠ¨åŠ›å­¦ï¼‰è¾“å‡ºå¹¶ä¸º DeePMD-kit å‡†å¤‡è®­ç»ƒæ•°æ®æ—¶çš„å·¥ä½œæµç¨‹ã€‚

è¿™ä¸ªæµç¨‹çš„æ ¸å¿ƒç›®æ ‡æ˜¯**ä»CP2Kçš„è¾“å‡ºä¸­æå–æ¯ä¸€æ­¥çš„åŸå­åæ ‡ã€èƒ½é‡ã€åŸå­å—åŠ›ä»¥åŠæ™¶èƒå‚æ•°**ï¼Œå¹¶å°†å®ƒä»¬è½¬æ¢æˆDeePMD-kitèƒ½å¤Ÿè¯†åˆ«çš„ `npy` æ–‡ä»¶æ ¼å¼ã€‚

***

## 1. æ ¸å¿ƒå·¥ä½œæµç¨‹æ¦‚è§ˆ

1.  **ç”¨æˆ·é€šè¿‡ `dpdata` è°ƒç”¨**ï¼š
    ç”¨æˆ·é€šå¸¸ä¸ä¼šç›´æ¥ä¸ `cp2kdata` çš„æ‰€æœ‰å†…éƒ¨æ¨¡å—äº¤äº’ï¼Œè€Œæ˜¯é€šè¿‡ `dpdata` åº“æ¥åŠ è½½æ•°æ®ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·å¯èƒ½ä¼šæ‰§è¡Œç±»ä¼¼ `dpdata.LabeledSystem('your_cp2k_output_directory', fmt='cp2k/aimd_output')` çš„å‘½ä»¤ã€‚

2.  **`dpdata` æ’ä»¶æœºåˆ¶ç”Ÿæ•ˆ (`cp2kdata/dpdata_plugin.py`)**ï¼š
    * `dpdata` è¯†åˆ«åˆ°æ ¼å¼ `'cp2k/aimd_output'` (æˆ–è€… `'cp2kdata/md'`)ï¼Œç„¶åè°ƒç”¨åœ¨ `cp2kdata/dpdata_plugin.py` ä¸­æ³¨å†Œçš„ `CP2KMDFormat` ç±»ã€‚
    * å…³é”®æ–¹æ³•æ˜¯ `CP2KMDFormat.from_labeled_system()`ã€‚æ­¤æ–¹æ³•è´Ÿè´£åè°ƒæ•´ä¸ªè§£æå’Œæ•°æ®æå–è¿‡ç¨‹ã€‚

3.  **æ ¸å¿ƒè§£æå™¨ `Cp2kOutput` åˆå§‹åŒ– (`cp2kdata/output.py`)**ï¼š
    * åœ¨ `CP2KMDFormat.from_labeled_system()` å†…éƒ¨ï¼Œä¼šåˆ›å»ºä¸€ä¸ª `Cp2kOutput` ç±»çš„å®ä¾‹ï¼š`cp2kmd = Cp2kOutput(output_file=cp2k_output_name, run_type="MD", path_prefix=path_prefix, ...)`ã€‚
    * `Cp2kOutput.__init__()` æ–¹æ³•æ˜¯å®é™…è§£æçš„èµ·ç‚¹ã€‚å®ƒä¼šï¼š
        * ç¡®å®š CP2K çš„è¿è¡Œç±»å‹ï¼ˆåœ¨è¿™é‡Œæ˜¯ "MD"ï¼‰ã€‚
        * æ ¹æ®è¿è¡Œç±»å‹ï¼ˆ"MD"ï¼‰ï¼Œè°ƒç”¨ç›¸åº”çš„è§£ææ–¹æ³•ï¼Œå³ `self.parse_md()`ã€‚

4.  **AIMD æ•°æ®è§£æ (`Cp2kOutput.parse_md()` åœ¨ `cp2kdata/output.py`)**ï¼š
    * è¿™ä¸ªæ–¹æ³•æ˜¯é’ˆå¯¹ MD è¾“å‡ºçš„æ ¸å¿ƒè§£æé€»è¾‘ã€‚å®ƒä¼šå°è¯•ä»å¤šä¸ªæ¥æºè·å–æ•°æ®ï¼Œä¼˜å…ˆé¡ºåºé€šå¸¸æ˜¯ï¼š
        * **ä¸“ç”¨è½¨è¿¹æ–‡ä»¶**ï¼šCP2K MDè®¡ç®—é€šå¸¸ä¼šè¾“å‡ºä¸€äº›ä¸“é—¨çš„æ–‡ä»¶ï¼Œå¦‚ï¼š
            * èƒ½é‡ï¼š`*.ener` æ–‡ä»¶ (é€šè¿‡ `cp2kdata.block_parser.md_xyz.parse_md_ener()` è§£æ)ã€‚
            * åŸå­åæ ‡ï¼š`*-pos-*.xyz` æ–‡ä»¶ (é€šè¿‡ `cp2kdata.block_parser.md_xyz.parse_pos_xyz()` è§£æï¼Œæ­¤å‡½æ•°ä¹Ÿä¼šå°è¯•æå–èƒ½é‡)ã€‚
            * åŸå­å—åŠ›ï¼š`*-frc-*.xyz` æ–‡ä»¶ (é€šè¿‡ `cp2kdata.block_parser.md_xyz.parse_frc_xyz()` è§£æ)ã€‚
            * æ™¶èƒå‚æ•°ï¼š`*.cell` æ–‡ä»¶ (é€šè¿‡ `cp2kdata.block_parser.md_xyz.parse_md_cell()` è§£æ)ã€‚
            * åº”åŠ›å¼ é‡ï¼š`*.stress` æ–‡ä»¶ (é€šè¿‡ `cp2kdata.block_parser.md_xyz.parse_md_stress()` è§£æï¼Œä½†ä»£ç æ³¨é‡Šè¡¨æ˜å¯èƒ½å­˜åœ¨å•ä½æˆ–æ”¯æŒé—®é¢˜ï¼Œä¸»è¦è¿˜æ˜¯ä¾èµ–ä¸»è¾“å‡ºæ–‡ä»¶)ã€‚
        * **ä¸»è¾“å‡ºæ–‡ä»¶ (cp2k.out)**ï¼šå¦‚æœä¸Šè¿°ä¸“ç”¨æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæˆ–è€…æŸäº›ä¿¡æ¯åœ¨ä¸“ç”¨æ–‡ä»¶ä¸­ç¼ºå¤±ï¼Œ`parse_md()` ä¼šå›é€€åˆ°è§£æ CP2K çš„ä¸»è¾“å‡ºæ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯ `cp2k.out` æˆ–ç”¨æˆ·æŒ‡å®šçš„æ–‡ä»¶åï¼‰ã€‚è¿™æ—¶ä¼šç”¨åˆ° `cp2kdata.block_parser` ä¸­çš„å…¶ä»–æ¨¡å—ï¼š
            * èƒ½é‡ï¼š`cp2kdata.block_parser.energies.parse_energies_list()`ã€‚
            * åŸå­å—åŠ›ï¼š`cp2kdata.block_parser.forces.parse_atomic_forces_list()`ã€‚
            * åº”åŠ›å¼ é‡ï¼š`cp2kdata.block_parser.stress.parse_stress_tensor_list()`ã€‚
            * æ™¶èƒå‚æ•°ï¼š`cp2kdata.block_parser.cells.parse_all_md_cells()` æˆ– `parse_all_cells()`ï¼Œå–å†³äºCP2Kç‰ˆæœ¬å’Œç³»ç»¼ç±»å‹ã€‚
        * **åˆå§‹ç»“æ„å’ŒåŸå­ç±»å‹ä¿¡æ¯**ï¼šé€šå¸¸ä»ä¸»è¾“å‡ºæ–‡ä»¶ä¸­è§£æï¼Œä¾‹å¦‚ä½¿ç”¨ `cp2kdata.block_parser.coordinates.parse_init_atomic_coordinates()` å’Œ `cp2kdata.block_parser.atomic_kind.parse_atomic_kinds()`ã€‚

5.  **æ•°æ®æå–å’Œè½¬æ¢ (`cp2kdata/dpdata_plugin.py`)**ï¼š
    * å½“ `Cp2kOutput` å®ä¾‹ (`cp2kmd`) å®Œæˆè§£æåï¼Œ`CP2KMDFormat.from_labeled_system()` æ–¹æ³•ä¼šé€šè¿‡è°ƒç”¨ `cp2kmd` çš„å„ç§ getter æ–¹æ³•æˆ–ç›´æ¥è®¿é—®å…¶å±æ€§æ¥è·å–è§£æåˆ°çš„æ•°æ®ï¼Œä¾‹å¦‚ï¼š
        * `cp2kmd.energies_list`
        * `cp2kmd.atomic_frames_list` (åŸå­åæ ‡)
        * `cp2kmd.atomic_forces_list`
        * `cp2kmd.get_all_cells()`
        * `cp2kmd.get_chemical_symbols()` æˆ– `get_chemical_symbols_fake()` (é€šè¿‡è¾…åŠ©å‡½æ•° `get_chemical_symbols_from_cp2kdata`)
    * æ¥ç€ï¼Œè¿›è¡Œå•ä½è½¬æ¢ âš™ï¸ï¼š
        * èƒ½é‡ä» Hartree è½¬æ¢ä¸º eV (ä½¿ç”¨ `AU_TO_EV` æ¥è‡ª `cp2kdata.dpdata_plugin`)ã€‚
        * åŠ›å’Œåæ ‡é•¿åº¦ä» Bohr/Hartree è½¬æ¢ä¸º Angstrom/eV (ä½¿ç”¨ `AU_TO_ANG` å’Œ `AU_TO_EV`)ã€‚
        * åº”åŠ›/Virial çš„å•ä½è½¬æ¢ (ä½¿ç”¨ `EV_ANG_m3_TO_GPa`)ã€‚
    * æœ€åï¼Œæ‰€æœ‰è¿™äº›æ•°æ®è¢«ç»„ç»‡æˆä¸€ä¸ªå­—å…¸ `data`ï¼Œå…¶é”®åç¬¦åˆ `dpdata` çš„æœŸæœ›ï¼ˆå¦‚ 'energies', 'coords', 'forces', 'cells', 'atom_names', 'atom_types', 'virials'ï¼‰ã€‚

6.  **`dpdata` åç»­å¤„ç†**ï¼š
    * `dpdata` æ¥æ”¶åˆ°è¿™ä¸ª `data` å­—å…¸åï¼Œä¼šç”¨å®ƒæ¥æ„å»ºå…¶å†…éƒ¨çš„ `System` å¯¹è±¡ã€‚
    * ç”¨æˆ·éšåå¯ä»¥ä½¿ç”¨ `dpdata` çš„åŠŸèƒ½å°†è¿™ä¸ª `System` å¯¹è±¡çš„æ•°æ®ä¿å­˜ä¸º DeePMD-kit æ‰€éœ€çš„ `npy` æ–‡ä»¶ç»“æ„ (ä¾‹å¦‚ï¼Œ`raw/system_name/set.000/` ç›®å½•ä¸‹çš„ `coord.npy`, `energy.npy`, `force.npy`, `box.npy`, `type.raw` ç­‰)ã€‚

***
<br>

## 2. æ¶‰åŠçš„å…³é”®è„šæœ¬ã€ç±»å’Œå‡½æ•°æ€»ç»“

* **`cp2kdata/__init__.py`**ï¼š
    * åŒ…çš„å…¥å£ç‚¹ï¼Œå¯¼å…¥äº†ä¸»è¦çš„ç±»å¦‚ `Cp2kOutput`ã€‚

* **`cp2kdata/dpdata_plugin.py`**ï¼š
    * **`CP2KMDFormat(Format)` ç±»**ï¼š`dpdata` çš„æ’ä»¶ç±»ï¼Œç”¨äºå¤„ç† CP2K MD è¾“å‡ºã€‚
        * `@Format.register("cp2k/aimd_output")` å’Œ `@Format.register("cp2kdata/md")`ï¼šå‘ `dpdata` æ³¨å†Œæ­¤æ ¼å¼å¤„ç†å™¨ã€‚
        * **`from_labeled_system()` æ–¹æ³•**ï¼šè¢« `dpdata` è°ƒç”¨çš„æ ¸å¿ƒæ–¹æ³•ï¼Œé©±åŠ¨æ•´ä¸ªè§£ææµç¨‹ã€‚å®ƒå®ä¾‹åŒ– `Cp2kOutput`ï¼Œè°ƒç”¨å…¶æ–¹æ³•è·å–æ•°æ®ï¼Œè¿›è¡Œå•ä½è½¬æ¢ï¼Œå¹¶è¿”å›ç»™ `dpdata`ã€‚
        * `AU_TO_EV`, `AU_TO_ANG`, `EV_ANG_m3_TO_GPa`ï¼šå•ä½è½¬æ¢å¸¸é‡ã€‚
        * `get_chemical_symbols_from_cp2kdata()`ï¼šè¾…åŠ©å‡½æ•°ï¼Œç”¨äºè·å–åŸå­ç¬¦å·ã€‚
        * `get_uniq_atom_names_and_types()`ï¼šè¾…åŠ©å‡½æ•°ï¼Œç”¨äºç”ŸæˆåŸå­ç±»å‹æ˜ å°„ã€‚

* **`cp2kdata/output.py`**ï¼š
    * **`Cp2kOutput` ç±»**ï¼šä¸»è¦çš„CP2Kè¾“å‡ºæ–‡ä»¶è§£æå™¨ã€‚
        * **`__init__()` æ–¹æ³•**ï¼šåˆå§‹åŒ–è§£æå™¨ï¼Œè¯»å–ä¸»è¾“å‡ºæ–‡ä»¶ï¼Œè°ƒç”¨ `parse_global_info` ç¡®å®šè¿è¡Œç±»å‹ï¼Œå¹¶æ ¹æ®è¿è¡Œç±»å‹åˆ†æ´¾åˆ°å…·ä½“çš„è§£æå‡½æ•°ã€‚
        * **`parse_md()` æ–¹æ³•**ï¼šä¸“é—¨è§£æMDç±»å‹è®¡ç®—çš„è¾“å‡ºã€‚å®ƒä¼šå°è¯•è§£æ `.ener`, `*-pos-*.xyz`, `*-frc-*.xyz`, `*.cell`, `*.stress` ç­‰æ–‡ä»¶ï¼Œå¦‚æœå¤±è´¥åˆ™ä»ä¸»è¾“å‡ºæ–‡ä»¶ä¸­æå–ä¿¡æ¯ã€‚
        * **å„ç§ `get_...()` æ–¹æ³•** (å¦‚ `get_all_cells()`, `get_chemical_symbols()`) å’Œå±æ€§ (`energies_list`, `atomic_frames_list`, `atomic_forces_list`, `stress_tensor_list`)ï¼šç”¨äºå‘å¤–éƒ¨ï¼ˆå¦‚ `CP2KMDFormat`ï¼‰æä¾›è§£æåçš„æ•°æ®ã€‚
        * å†…éƒ¨è°ƒç”¨äº†å¤§é‡æ¥è‡ª `cp2kdata.block_parser` å­æ¨¡å—çš„è§£æå‡½æ•°ã€‚

* **`cp2kdata/block_parser/` (ç›®å½•)**ï¼šåŒ…å«é’ˆå¯¹CP2Kè¾“å‡ºæ–‡ä»¶ä¸­ç‰¹å®šæ•°æ®å—æˆ–ç‰¹å®šè¾…åŠ©æ–‡ä»¶çš„è§£æå™¨ã€‚
    * **`md_xyz.py`**ï¼š
        * `parse_md_ener()`ï¼šè§£æ `.ener` æ–‡ä»¶ã€‚
        * `parse_pos_xyz()`ï¼šè§£æ `*-pos-*.xyz` æ–‡ä»¶ã€‚
        * `parse_frc_xyz()`ï¼šè§£æ `*-frc-*.xyz` æ–‡ä»¶ã€‚
        * `parse_md_cell()`ï¼šè§£æ `*.cell` æ–‡ä»¶ã€‚
        * `parse_md_stress()`ï¼šè§£æ `*.stress` æ–‡ä»¶ã€‚
    * **`energies.py`**ï¼š`parse_energies_list()` (ä»ä¸»è¾“å‡ºæ–‡ä»¶)ã€‚
    * **`forces.py`**ï¼š`parse_atomic_forces_list()` (ä»ä¸»è¾“å‡ºæ–‡ä»¶)ã€‚
    * **`cells.py`**ï¼š`parse_all_cells()`, `parse_all_md_cells()` (ä»ä¸»è¾“å‡ºæ–‡ä»¶)ã€‚
    * **`stress.py`**ï¼š`parse_stress_tensor_list()` (ä»ä¸»è¾“å‡ºæ–‡ä»¶)ã€‚
    * **`coordinates.py`**ï¼š`parse_init_atomic_coordinates()` (ä»ä¸»è¾“å‡ºæ–‡ä»¶)ã€‚
    * **`atomic_kind.py`**ï¼š`parse_atomic_kinds()` (ä»ä¸»è¾“å‡ºæ–‡ä»¶)ã€‚
    * **`header_info.py`**ï¼š`parse_global_info()`, `parse_cp2k_info()`, `parse_md_info()` ç­‰ï¼Œç”¨äºè§£æè¾“å‡ºæ–‡ä»¶å¤´éƒ¨ä¿¡æ¯ï¼Œå¦‚CP2Kç‰ˆæœ¬ã€è¿è¡Œç±»å‹ã€ç³»ç»¼ç±»å‹ç­‰ã€‚
    * **`converge.py`**ï¼š`parse_e_f_converge()` æ£€æŸ¥èƒ½é‡åŠ›è®¡ç®—æ˜¯å¦æ”¶æ•› (åœ¨ `CP2KEnergyForceFormat` ä¸­ä½¿ç”¨ï¼Œå¯¹MDæµç¨‹å½±å“è¾ƒå°ï¼Œä½†å¯ç”¨äºåˆ¤æ–­å•ç‚¹è®¡ç®—çš„æœ‰æ•ˆæ€§)ã€‚

* **`cp2kdata/log.py`**ï¼š
    * `get_logger()`ï¼šæä¾›æ—¥å¿—è®°å½•åŠŸèƒ½ ğŸ“ã€‚

* **`cp2kdata/units.py`**ï¼š
    * å®šä¹‰äº†å„ç§ç‰©ç†å•ä½è½¬æ¢å¸¸æ•°ï¼Œä½† `dpdata_plugin.py` ä¸­ä¼¼ä¹ä¼˜å…ˆä½¿ç”¨äº† `dpdata.unit` æ¨¡å—çš„è½¬æ¢ï¼ˆè¿™æ˜¯ä¸€ä¸ªå¥½çš„å®è·µï¼Œä»¥ä¿æŒä¸ `dpdata` ç”Ÿæ€çš„ä¸€è‡´æ€§ï¼‰ã€‚

* **`cp2kdata/utils.py`**ï¼š
    * åŒ…å«ä¸€äº›é€šç”¨å·¥å…·å‡½æ•°ï¼Œå¦‚ `format_logger` ç”¨äºæ ¼å¼åŒ–æ—¥å¿—è¾“å‡ºã€‚

***
<br>
ç®€å•æ¥è¯´ï¼Œå·¥ä½œæµæ˜¯ï¼š
**`dpdata` â¡ï¸ `CP2KMDFormat` (dpdata_plugin) â¡ï¸ `Cp2kOutput` (output) â¡ï¸ `block_parser` æ¨¡å— â¡ï¸ æ•°æ®è¿”å›ç»™ `CP2KMDFormat` â¡ï¸ æ•°æ®è¿”å›ç»™ `dpdata` â¡ï¸ `npy` æ–‡ä»¶** ğŸ’¾ã€‚

è¿™ä¸ªæµç¨‹è®¾è®¡å¾—æ¯”è¾ƒæ¨¡å—åŒ–ï¼Œ`Cp2kOutput` è´Ÿè´£æ ¸å¿ƒçš„è§£æé€»è¾‘ï¼Œè€Œ `CP2KMDFormat` åˆ™å……å½“äº† `Cp2kOutput` å’Œ `dpdata` ä¹‹é—´çš„æ¡¥æ¢ï¼Œå¤„ç†æ•°æ®æ ¼å¼çš„é€‚é…å’Œå•ä½è½¬æ¢ã€‚å„ä¸ª `block_parser` æ¨¡å—åˆ™ä¸“æ³¨äºè§£æCP2Kè¾“å‡ºä¸­ç‰¹å®šéƒ¨åˆ†çš„å†…å®¹ã€‚





