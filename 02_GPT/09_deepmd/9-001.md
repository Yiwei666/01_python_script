# dpdata数据格式转换

# 1. cp2k输出文件格式转换

## 1. dpdata和cp2kdata安装配置

### 1. dpdata安装

1. 安装

```sh
# 安装或升级 dpdata/cp2kdata
pip install -U dpdata
pip install -U cp2kdata

pip install dpdata

dpdata --version
```

### 2. `System` 和 `LabeledSystem` 支持的属性

| **键**          | **类型**          | **维度**                  | **是否标签** | **描述**           |
|-----------------|------------------|--------------------------|-------------|-------------------|
| `'atom_names'`  | `list of str`    | `ntypes`                | 否          | 原子类型名称       |
| `'atom_numbs'`  | `list of int`    | `ntypes`                | 否          | 每种类型的原子数量 |
| `'atom_types'`  | `np.ndarray`     | `natoms`                | 否          | 每个原子的类型分配 |
| `'cells'`       | `np.ndarray`     | `nframes x 3 x 3`       | 否          | 每帧的晶胞张量     |
| `'coords'`      | `np.ndarray`     | `nframes x natoms x 3`  | 否          | 原子坐标           |
| `'energies'`    | `np.ndarray`     | `nframes`               | 是          | 每帧的能量         |
| `'forces'`      | `np.ndarray`     | `nframes x natoms x 3`  | 是          | 每个原子的受力     |
| `'virials'`     | `np.ndarray`     | `nframes x 3 x 3`       | 是          | 每帧的应力张量     |




## 2. 单点能计算数据处理

### 1. 官方文档案例

1. cp2k单点能和从头算输出文件结构

```bash
./00_fp
├── 000
│   ├── STDOUTERR
│   ├── input.inp
│   ├── job_cp2k.json
│   ├── lbg-13387-8917799.sh
│   ├── lbg-13387-8917799.sh.bak
│   ├── lbg-13387-8918922.sh
│   ├── lbg-13387-8918922.sh.bak
│   └── output.log
└── 001
    ├── STDOUTERR
    ├── input.inp
    ├── job_cp2k.json
    ├── lbg-13387-8917816.sh
    ├── lbg-13387-8917816.sh.bak
    ├── lbg-13387-8918924.sh
    ├── lbg-13387-8918924.sh.bak
    └── output.log
```

注意：对于单点能计算，盒子、能量、原子坐标及force数据均从 output.log 文件中提取。


```bash
2 directories, 16 files
./00_aimd
├── 000
│   ├── STDOUTERR
│   ├── aimd-1.ener
│   ├── aimd-1.restart
│   ├── aimd-1.restart.bak-1
│   ├── aimd-1.restart.bak-2
│   ├── aimd-frc-1.xyz
│   ├── aimd-pos-1.xyz
│   ├── input.inp
│   ├── job_cp2k.json
│   ├── lbg-13387-8917653.sh
│   ├── lbg-13387-8917653.sh.bak
│   ├── lbg-13387-8918919.sh
│   ├── lbg-13387-8918919.sh.bak
│   └── output.log
└── 001
    ├── STDOUTERR
    ├── aimd-1.ener
    ├── aimd-1.restart
    ├── aimd-1.restart.bak-1
    ├── aimd-1.restart.bak-2
    ├── aimd-frc-1.xyz
    ├── aimd-pos-1.xyz
    ├── input.inp
    ├── job_cp2k.json
    ├── lbg-13387-8917688.sh
    ├── lbg-13387-8917688.sh.bak
    ├── lbg-13387-8918920.sh
    ├── lbg-13387-8918920.sh.bak
    └── output.log

2 directories, 28 files
```

对于从头算，由于 output.log 文件中并未含有每一帧的原子坐标、force等详细信息，因此 dpdata 可能从同级目录下调用 `pos-1.xyz、frc-1.xyz` 等文件来进行数据转换


2. cp2k单点能计算输入文件示例

```bash
#Generated by Multiwfn
&GLOBAL
  PROJECT data_md_ave
  PRINT_LEVEL MEDIUM
  RUN_TYPE ENERGY_FORCE
&END GLOBAL

&FORCE_EVAL
  METHOD Quickstep
  STRESS_TENSOR ANALYTICAL
  &SUBSYS
    &CELL
      A     22.27050018      0.00000000      0.00000000
      B      0.00000000     22.27050018      0.00000000
      C      0.00000000      0.00000000     22.27050018
      PERIODIC XYZ #Direction(s) of applied PBC (geometry aspect)
    &END CELL
    &COORD
      C            0.104120    19.891457    16.117207
      C           22.148861    21.201803    16.862242
      O            0.661542    22.181522    16.080223
      ......
      # 省略原子坐标
      H           18.236288    17.427950    18.632980
      H           17.611443    18.594219    19.880655
      H           15.624798    17.594215    19.592993
      H           16.069569    16.531801    18.298908
    &END COORD
#   &VELOCITY #You can set initial atomic velocities in this section
#   &END VELOCITY
    &KIND C
      ELEMENT C
      BASIS_SET TZV2P-GTH-q4
      POTENTIAL GTH-PBE
    &END KIND
    &KIND O
      ELEMENT O
      BASIS_SET TZV2P-GTH-q6
      POTENTIAL GTH-PBE
    &END KIND
    &KIND H
      ELEMENT H
      BASIS_SET TZV2P-GTH-q1
      POTENTIAL GTH-PBE
    &END KIND
    &KIND Li
      ELEMENT Li
      BASIS_SET TZV2P-GTH-q3
      POTENTIAL GTH-PBE
    &END KIND
    &KIND P
      ELEMENT P
      BASIS_SET TZV2P-GTH-q5
      POTENTIAL GTH-PBE
    &END KIND
    &KIND F
      ELEMENT F
      BASIS_SET TZV2P-GTH-q7
      POTENTIAL GTH-PBE
    &END KIND
  &END SUBSYS

  &DFT
    BASIS_SET_FILE_NAME  GTH_BASIS_SETS
    POTENTIAL_FILE_NAME  POTENTIAL
#   WFN_RESTART_FILE_NAME md_ave_10-RESTART.wfn
    CHARGE    0 #Net charge
    MULTIPLICITY    1 #Spin multiplicity
    &QS
      EPS_DEFAULT 1.0E-10 #Set all EPS_xxx to values such that the energy will be correct up to this value
      EXTRAPOLATION ASPC #Extrapolation for wavefunction during e.g. MD. ASPC is default, PS can also be used
      EXTRAPOLATION_ORDER 3 #Order for PS or ASPC extrapolation. 3 is default
    &END QS
    &POISSON
      PERIODIC XYZ #Direction(s) of PBC for calculating electrostatics
      PSOLVER PERIODIC #The way to solve Poisson equation
    &END POISSON
    &XC
      &XC_FUNCTIONAL PBE
      &END XC_FUNCTIONAL
      &VDW_POTENTIAL
        POTENTIAL_TYPE PAIR_POTENTIAL
        &PAIR_POTENTIAL
          PARAMETER_FILE_NAME dftd3.dat
          TYPE DFTD3(BJ)
          REFERENCE_FUNCTIONAL PBE
          #CALCULATE_C9_TERM T #Calculate C9-related three-body term, more accurate for large system
        &END PAIR_POTENTIAL
      &END VDW_POTENTIAL
    &END XC
    &MGRID
      CUTOFF  800
      REL_CUTOFF  40
      NGRIDS 5 #The number of multigrids to use. 5 is optimal for MOLOPT-GTH basis sets
    &END MGRID
    &SCF
      MAX_SCF 25 #Maximum number of steps of inner SCF
      EPS_SCF 1.0E-05 #Convergence threshold of density matrix of inner SCF
#     SCF_GUESS RESTART #Use wavefunction from WFN_RESTART_FILE_NAME file as initial guess
      &OT
        PRECONDITIONER FULL_KINETIC #FULL_SINGLE_INVERSE is also worth to try. FULL_ALL is better but quite expensive for large system
        MINIMIZER DIIS #CG is worth to consider in difficult cases
        LINESEARCH 2PNT #1D line search algorithm for CG. 2PNT is default, 3PNT is better but more costly. GOLD is best but very expensive
        ALGORITHM STRICT #Algorithm of OT. Can be STRICT (default) or IRAC
      &END OT
      &OUTER_SCF
        MAX_SCF 20 #Maximum number of steps of outer SCF
        EPS_SCF 1.0E-05 #Convergence threshold of outer SCF
      &END OUTER_SCF
      &PRINT
        &RESTART OFF #Do not generate wfn file to suppress meaningless I/O cost
        &END RESTART
      &END PRINT
    &END SCF
  &END DFT
  &PRINT
    &FORCES ON           #Print atomic forces
    &END FORCES
  &END PRINT
&END FORCE_EVAL
```


3. 单点能计算数据转换官方示例


```py
# 更新dpdata,cp2kdata
! pip install -U dpdata
! pip install -U cp2kdata
import dpdata
import numpy as np


# 使用LabeledSystem读取CP2K的单点能输出文件
data=dpdata.LabeledSystem('00_fp/000/output.log',fmt='cp2k/output')
print(data)


# 指定元素顺序进行dpdata读取/转换
data=dpdata.LabeledSystem('00_fp/000/output.log',fmt='cp2k/output',type_map=['H','C','O'])
print(data)


# 转化为deepmd的数据格式并输出到指定位置
data.to_deepmd_npy('./01_dp/fp_single/',fmt='deepmd-npy')
! tree ./01_dp/fp_single/


# npy格式的文件读取,以energy为例
energy=np.load('./01_dp/fp_single/set.000/energy.npy')
print(len(energy))
print(energy)


# 使用LabeledSystem读取文件夹下多个CP2K的单点能输出文件
data=dpdata.MultiSystems.from_dir('00_fp',file_name='output.log',fmt='cp2k/output')
print(data)
print(data.systems)


# 转化为deepmd的数据格式并输出到指定位置
data.to_deepmd_npy('./01_dp/fp_all/',fmt='deepmd-npy')
! tree ./01_dp/fp_all/
```




### 2. cp2k单点能计算输出文件

- cp2k控制文件
  - `PRINT_LEVEL` 设置为 `MEDIUM`
  - `RUN_TYPE` 设置为 `ENERGY_FORCE`
  - `FORCE_EVAL`下的`&PRINT`打印`FORCES`

```inp
&GLOBAL
    PRINT_LEVEL MEDIUM
    PROJECT_NAME ${SYSNAME}
    RUN_TYPE ENERGY_FORCE
&END GLOBAL

&FORCE_EVAL
    METHOD  QS
    &DFT
        ...   
    &END DFT
    &SUBSYS
        ...
    &END SUBSYS
    &PRINT
        &FORCES ON           #Print atomic forces
        &END FORCES
    &END PRINT
&END FORCE_EVAL
```

在CP2K中，`PRINT_LEVEL` 的默认值是 `MEDIUM`，而 `RUN_TYPE` 的默认值是 `ENERGY_FORCE`。某些时候，这两个关键词被省略，即使用默认值也是符合要求的。



- cmd命令依次执行如下命令

`tem.out`是cp2k单点能计算输出文件（包含运行信息、体系信息和计算结果等），cp2k计算的任务类型是 `RUN_TYPE ENERGY_FORCE`。使用关键词`cp2k/output`指定`tem.out`文件类型

```python
# 使用LabeledSystem读取CP2K的单点能输出文件
import dpdata
import numpy as np
data=dpdata.LabeledSystem('tem.out',fmt='cp2k/output')
print(data)
print(data["coords"])
print(data["energies"])
print(data["forces"])
# 转化为deepmd的数据格式并输出到指定位置（当前目录的子文件夹 sub_folder ）
data.to_deepmd_npy('./sub_folder/',fmt='deepmd-npy')
```



- 示例输出

注：测试文件位于 `cp2k_model\80_B-slag-E\diag-120_energy_force`  路径下

```python
Type "help", "copyright", "credits" or "license" for more information.
>>> import dpdata
>>> import numpy as np
>>> data=dpdata.LabeledSystem('tem.out',fmt='cp2k/output')

>>> print(data)
Data Summary
Labeled System
-------------------
Frame Numbers      : 1
Atom Numbers       : 226
Including Virials  : No
Element List       :
-------------------
B  O  Si  Ca
8  135  40  43

>>> print(data["coords"])
[[[1.5307190e+00 1.2526217e+01 1.0197713e+01]
  [8.7254510e+00 8.6880330e+00 7.0680320e+00]
  [9.1087680e+00 5.5990580e+00 6.6161680e+00]
  ......
  [4.0823450e+00 1.0573016e+01 9.3888270e+00]
  [8.1104590e+00 4.1514110e+00 4.3153410e+00]
  [2.8667400e+00 3.6892390e+00 1.2441217e+01]
  [2.7173800e-01 5.2957740e+00 3.3176500e-01]]]

>>> print(data["energies"])
[-107106.42005917]

>>> print(data["forces"])
[[[-1.95376551  1.73994587 -0.73027101]
  [ 0.85260668  1.21704721  1.95160527]
  [ 0.13513565  0.20607959 -0.38610208]
  ......
  [-0.8725101  -0.01692403  0.68197951]
  [-0.53420638  1.33620859 -0.5776138 ]
  [ 0.54489497  0.50672848 -0.04356066]
  [ 2.10692203 -0.31649768  1.58288848]]]
```

- 命令`data.to_deepmd_npy('./sub_folder/',fmt='deepmd-npy')`执行后生成的新目录结构

```
├── sub_folder
    ├── set.000
        ├── box.npy
        ├── coord.npy
        ├── energy.npy
        └── force.npy
    ├── type.raw
    └── type_map.raw
```

上述输出的各文件内容如下：

- `set.000/` 包含数值数据文件：
  - `box.npy`：模拟盒子的几何信息
  - `coord.npy`：原子的三维坐标
  - `energy.npy`：每个配置的总能量
  - `force.npy`：每个原子的力信息
- `type.raw` 定义了数据集中所有原子的类型（如元素种类）。
- `type_map.raw` 提供原子类型与模型内部标识符之间的映射关系。




### 3. 输出为deepmd数据和npy数据读取

`.npy` 数据格式是 NumPy 提供的一种专用二进制文件格式，用于高效存储和读取 NumPy 数组

- 命令行：

```py
import dpdata
import numpy as np
energy=np.load('./deepmd_fmt/set.000/energy.npy')
print(len(energy))
print(energy)
```

- 输出示例：

```
>>> print(len(energy))
1
>>> print(energy)
[[-107106.42005917]]
```





## 3. AIMD单条轨迹数据转换

### 1. 官方文档案例

- cp2k计算控制文件

```bash
#Generated by Multiwfn
&GLOBAL
  PROJECT aimd
  PRINT_LEVEL MEDIUM
  RUN_TYPE MD
&END GLOBAL

&FORCE_EVAL
  METHOD Quickstep
  STRESS_TENSOR ANALYTICAL
  &SUBSYS
    &CELL
      A     17.67609978      0.00000000      0.00000000
      B      0.00000000     17.67609978      0.00000000
      C      0.00000000      0.00000000     17.67609978
      PERIODIC XYZ #Direction(s) of applied PBC (geometry aspect)
    &END CELL
    &COORD
      C            7.760000    13.760000     7.720000
      C            8.940000    12.820000     7.550000
      O            9.350000    13.110000     6.220000
      ......
      # 省略原子坐标
      H           11.080000    11.420000     4.860000
      H           11.520000    13.660001     5.350000
      H           11.530000    13.830000     3.580000
    &END COORD
#   &VELOCITY #You can set initial atomic velocities in this section
#   &END VELOCITY
    &KIND C
      ELEMENT C
      BASIS_SET TZV2P-GTH-q4
      POTENTIAL GTH-PBE
    &END KIND
    &KIND O
      ELEMENT O
      BASIS_SET TZV2P-GTH-q6
      POTENTIAL GTH-PBE
    &END KIND
    &KIND H
      ELEMENT H
      BASIS_SET TZV2P-GTH-q1
      POTENTIAL GTH-PBE
    &END KIND
    &KIND Li
      ELEMENT Li
      BASIS_SET TZV2P-GTH-q3
      POTENTIAL GTH-PBE
    &END KIND
    &KIND P
      ELEMENT P
      BASIS_SET TZV2P-GTH-q5
      POTENTIAL GTH-PBE
    &END KIND
    &KIND F
      ELEMENT F
      BASIS_SET TZV2P-GTH-q7
      POTENTIAL GTH-PBE
    &END KIND
  &END SUBSYS

  &DFT
    BASIS_SET_FILE_NAME  GTH_BASIS_SETS
    POTENTIAL_FILE_NAME  POTENTIAL
#   WFN_RESTART_FILE_NAME md_ave_10-RESTART.wfn
    CHARGE    0 #Net charge
    MULTIPLICITY    1 #Spin multiplicity
    &QS
      EPS_DEFAULT 1.0E-10 #Set all EPS_xxx to values such that the energy will be correct up to this value
      EXTRAPOLATION ASPC #Extrapolation for wavefunction during e.g. MD. ASPC is default, PS can also be used
      EXTRAPOLATION_ORDER 3 #Order for PS or ASPC extrapolation. 3 is default
    &END QS
    &POISSON
      PERIODIC XYZ #Direction(s) of PBC for calculating electrostatics
      PSOLVER PERIODIC #The way to solve Poisson equation
    &END POISSON
    &XC
      &XC_FUNCTIONAL PBE
      &END XC_FUNCTIONAL
      &VDW_POTENTIAL
        POTENTIAL_TYPE PAIR_POTENTIAL
        &PAIR_POTENTIAL
          PARAMETER_FILE_NAME dftd3.dat
          TYPE DFTD3(BJ)
          REFERENCE_FUNCTIONAL PBE
          #CALCULATE_C9_TERM T #Calculate C9-related three-body term, more accurate for large system
        &END PAIR_POTENTIAL
      &END VDW_POTENTIAL
    &END XC
    &MGRID
      CUTOFF  800
      REL_CUTOFF  40
      NGRIDS 5 #The number of multigrids to use. 5 is optimal for MOLOPT-GTH basis sets
    &END MGRID
    &SCF
      MAX_SCF 25 #Maximum number of steps of inner SCF
      EPS_SCF 1.0E-05 #Convergence threshold of density matrix of inner SCF
#     SCF_GUESS RESTART #Use wavefunction from WFN_RESTART_FILE_NAME file as initial guess
      &OT
        PRECONDITIONER FULL_KINETIC #FULL_SINGLE_INVERSE is also worth to try. FULL_ALL is better but quite expensive for large system
        MINIMIZER DIIS #CG is worth to consider in difficult cases
        LINESEARCH 2PNT #1D line search algorithm for CG. 2PNT is default, 3PNT is better but more costly. GOLD is best but very expensive
        ALGORITHM STRICT #Algorithm of OT. Can be STRICT (default) or IRAC
      &END OT
      &OUTER_SCF
        MAX_SCF 20 #Maximum number of steps of outer SCF
        EPS_SCF 1.0E-05 #Convergence threshold of outer SCF
      &END OUTER_SCF
      &PRINT
        &RESTART OFF #Do not generate wfn file to suppress meaningless I/O cost
        &END RESTART
      &END PRINT
    &END SCF
  &END DFT
&END FORCE_EVAL

&MOTION
  &MD
    ENSEMBLE NVT
    STEPS 50 #Number of steps to run
    TIMESTEP 1.0 #Step size in fs. Decrease it properly for high temperature simulation
    TEMPERATURE 300 #Initial and maintained temperature (K)
#   COMVEL_TOL 0 #Uncomment this can remove translation motion of center-of-mass every step
    &THERMOSTAT
      TYPE CSVR
      &CSVR
        TIMECON 25 #Time constant in fs. Smaller/larger results in stronger/weaker temperature coupling
      &END CSVR
    &END THERMOSTAT
  &END MD
  
  &PRINT
    &TRAJECTORY
      &EACH
        MD   1 #Output frequency of coordinates, 0 means never
      &END EACH
      FORMAT xyz
    &END TRAJECTORY
    &FORCES
      &EACH
        MD   1 #Output frequency of forces, 0 means never
      &END EACH
    &END FORCES
#    &RESTART
#      BACKUP_COPIES 0 #Maximum number of backing up restart file, 0 means never
#      &EACH
#        MD  10 #Frequency of updating last restart file, 0 means never
#      &END EACH
#    &END RESTART
  &END PRINT
&END MOTION

```


对于上述cp2k的aimd控制文件，需要重点关注以下几部分

```sh
&GLOBAL
  PROJECT aimd
  PRINT_LEVEL MEDIUM
  RUN_TYPE MD
&END GLOBAL

  &PRINT
    &TRAJECTORY
      &EACH
        MD   1 #Output frequency of coordinates, 0 means never
      &END EACH
      FORMAT xyz
    &END TRAJECTORY
    &FORCES
      &EACH
        MD   1 #Output frequency of forces, 0 means never
      &END EACH
    &END FORCES
#    &RESTART
#      BACKUP_COPIES 0 #Maximum number of backing up restart file, 0 means never
#      &EACH
#        MD  10 #Frequency of updating last restart file, 0 means never
#      &END EACH
#    &END RESTART
  &END PRINT

```

- 可以将 `motion` 模块直接使用以下部分替换，注意更改温度和运行步数

```sh
&MOTION
    &MD
        ENSEMBLE NVT
        &THERMOSTAT
            REGION MASSIVE
            TYPE NOSE
            &NOSE
                TIMECON 100
            &END NOSE
        &END THERMOSTAT
        STEPS 1000                                # 运行步数
        TEMPERATURE 1823                          # 温度
        TIMESTEP 1
    &END MD
    &PRINT
        &TRAJECTORY
            FORMAT XYZ
            &EACH
                MD 1
            &END EACH
        &END TRAJECTORY
        &FORCES
            &EACH
                MD 1
            &END EACH
        &END FORCES
    &END PRINT
&END MOTION
```


- aimd从头算数据转换命令

```py
import dpdata
import numpy as np

# 使用LabeledSystem读取CP2K的AIMD输出文件；注意第一个参数是aimd输出所在的文件夹位置
data=dpdata.LabeledSystem('./00_aimd/000/',cp2k_output_name='output.log',fmt='cp2kdata/md')
print(data)

# 转化为deepmd的数据格式并输出到指定位置
data.to_deepmd_npy('./01_dp/aimd_single/',fmt='deepmd-npy')
! tree ./01_dp/aimd_single/
```


### 2. aimd本地转换测试

1. 数据转换测试命令

测试目录位于 `cp2k_model\80_B-slag\deepmd_aimd\100-steps`

```py
import dpdata
import numpy as np

# 使用LabeledSystem读取CP2K的AIMD输出文件；注意第一个参数是aimd输出所在的文件夹位置
data=dpdata.LabeledSystem('./',cp2k_output_name='tem.out',fmt='cp2kdata/md')
print(data)

# 转化为deepmd的数据格式并输出到指定位置
data.to_deepmd_npy('./aimd_fmt/',fmt='deepmd-npy')  
```

注意：`dpdata.LabeledSystem()` 中的第一个参数需要注明aimd输出文件的路径，尤其是包含 日志文件、轨迹文件及force文件的路径。如果缺少相关文件，会出现如下类似的报错

```
No atomic coordinates found in cp2k output, do you have *-pos-*.xyz file?
TypeError: unsupported operand type(s) for *: 'NoneType' and 'float'
```

- 终端界面上显示的测试信息如下：

```py
>>> import dpdata
>>> import numpy as np
>>>
>>> # 使用LabeledSystem读取CP2K的AIMD输出文件；注意第一个参数是aimd输出所在的文件夹位置
>>> data=dpdata.LabeledSystem('./',cp2k_output_name='tem.out',fmt='cp2kdata/md')
CP2KDATA|
cp2kdata is parsing md cell information from output file.
The raw data of cell information are lengths and angles,
which are later transformed to cell matrices by codes.
However, the a axis of the cell are always assumed to be aligned to the x axis of the coordinate.
Make sure the a axis in real cell matrices are always aligned to x axis.
Otherwise, parsing cell information from `-1.cell` file is recommended.
CP2K input setup for write `-1.cell` file
------------------
&MOTION
 &PRINT
   &CELL
     &EACH
       MD 1
     &END EACH
   &END CELL
 &END PRINT
&END MOTION
------------------

>>> print(data)
Data Summary
Labeled System
-------------------
Frame Numbers      : 101
Atom Numbers       : 226
Including Virials  : No
Element List       :
-------------------
B  O  Si  Ca
8  135  40  43
```



### 3. aimd本地划分验证集和训练集


1. cmd命令行中执行如下python语句

```py
import dpdata
import numpy as np

# 使用LabeledSystem读取CP2K的AIMD输出文件；注意第一个参数是aimd输出所在的文件夹位置
data=dpdata.LabeledSystem('./',cp2k_output_name='tem.out',fmt='cp2kdata/md')
print('# 数据包含%d帧' % len(data))


# 随机选择20个索引作为验证集数据
index_validation = np.random.choice(101,size=20,replace=False)

# 其他索引作为训练集数据
index_training = list(set(range(101))-set(index_validation))
data_training = data.sub_system(index_training)
data_validation = data.sub_system(index_validation)

# 将所有训练数据放入文件夹"training_data"中
data_training.to_deepmd_npy('./00.data/training_data')

# 将所有验证数据放入文件夹"validation_data"中
data_validation.to_deepmd_npy('./00.data/validation_data')

print('# 训练数据包含%d帧' % len(data_training)) 
print('# 验证数据包含%d帧' % len(data_validation))
```


- 输出显示

```py
>>> import dpdata
>>> import numpy as np
>>>
>>> # 使用LabeledSystem读取CP2K的AIMD输出文件；注意第一个参数是aimd输出所在的文件夹位置
>>> data=dpdata.LabeledSystem('./',cp2k_output_name='tem.out',fmt='cp2kdata/md')
CP2KDATA|
cp2kdata is parsing md cell information from output file.
The raw data of cell information are lengths and angles,
which are later transformed to cell matrices by codes.
However, the a axis of the cell are always assumed to be aligned to the x axis of the coordinate.
Make sure the a axis in real cell matrices are always aligned to x axis.
Otherwise, parsing cell information from `-1.cell` file is recommended.
CP2K input setup for write `-1.cell` file
------------------
&MOTION
 &PRINT
   &CELL
     &EACH
       MD 1
     &END EACH
   &END CELL
 &END PRINT
&END MOTION
------------------

>>> print('# 数据包含%d帧' % len(data))
# 数据包含101帧
>>> # 随机选择20个索引作为验证集数据
>>> index_validation = np.random.choice(101,size=20,replace=False)
>>>
>>> # 其他索引作为训练集数据
>>> index_training = list(set(range(101))-set(index_validation))
>>> data_training = data.sub_system(index_training)
>>> data_validation = data.sub_system(index_validation)
>>>
>>> # 将所有训练数据放入文件夹"training_data"中
>>> data_training.to_deepmd_npy('./00.data/training_data')
>>>
>>> # 将所有验证数据放入文件夹"validation_data"中
>>> data_validation.to_deepmd_npy('./00.data/validation_data')
>>>
>>> print('# 训练数据包含%d帧' % len(data_training))
# 训练数据包含81帧
>>> print('# 验证数据包含%d帧' % len(data_validation))
# 验证数据包含20帧
>>>
```

- 文件结构

```sh
└── 100-steps
    ├── 00.data
        ├── training_data                 # 划分后的训练集
            ├── set.000
            ├── type.raw
            └── type_map.raw
        └── validation_data               # 划分后的验证集
            ├── set.000
            ├── type.raw
            └── type_map.raw
    ├── 01.train
    ├── 02.lmp
    ├── OT.inp
    ├── slagF120-frc-1.xyz                # aimd输出force文件
    ├── slagF120-pos-1.xyz                # aimd输出轨迹文件
    ├── slagF120.xyz                      # 初始模型文件
    ├── sub.sh
    └── tem.out                           # 日志文件
```


### 4. aimd本地划分验证/训练集_每隔若干帧

要求：
1. 随机从总共 101 帧中抽取 20 帧作为验证集索引（不重复）
2. 其余 81 帧中每隔5帧提取1帧作为训练集索引。
3. 将所有训练数据放入文件夹"training_data"中
4. 将所有验证数据放入文件夹"validation_data"中


- 简洁版

```py
import dpdata
import numpy as np

# 1. 读取 CP2K AIMD 输出并统计总帧数
data = dpdata.LabeledSystem('./', cp2k_output_name='tem.out', fmt='cp2kdata/md')
total_frames = len(data)
print(f'# 原始数据包含 {total_frames} 帧')

# 2. 随机抽取 20 帧作为验证集索引（不重复）
index_validation = np.random.choice(total_frames, size=20, replace=False)
print(f'# 验证集索引（共 {len(index_validation)} 帧）：{sorted(index_validation)}')

# 3. 其余帧中每隔 5 帧提取 1 帧作为训练集索引
remaining = sorted(set(range(total_frames)) - set(index_validation))
index_training = remaining[::5]
print(f'# 训练集索引（共 {len(index_training)} 帧）：{index_training}')

# 4. 根据索引拆分子系统
data_training   = data.sub_system(index_training)
data_validation = data.sub_system(index_validation)

# 5. 保存为 DeepMD-kit 格式
data_training.to_deepmd_npy('./00.data/training_data')
data_validation.to_deepmd_npy('./00.data/validation_data')

print(f'# 训练数据包含 {len(data_training)} 帧，已保存到 "./00.data/training_data"')
print(f'# 验证数据包含 {len(data_validation)} 帧，已保存到 "./00.data/validation_data"')
```

- 详细版

```py
import dpdata
import numpy as np

# 假设总帧数为 101，与原代码和您的描述一致
total_frames = 101

# 使用LabeledSystem读取CP2K的AIMD输出文件；注意第一个参数是aimd输出所在的文件夹位置
# 确保您的CP2K输出文件 'tem.out' 和相关数据在 './' 目录下
# 如果实际帧数与 total_frames 不符，dpdata 加载后 len(data) 会反映实际帧数
# 为确保代码按预期工作（特别是索引选择），最好让 total_frames 与 len(data) 一致
try:
    data = dpdata.LabeledSystem('./', cp2k_output_name='tem.out', fmt='cp2kdata/md')
    if len(data) != total_frames:
        print(f"# 警告: 代码中预设的总帧数 ({total_frames}) 与实际加载的帧数 ({len(data)}) 不符。")
        print(f"# 将使用实际加载的帧数 ({len(data)}) 进行后续操作。")
        total_frames = len(data)
        if total_frames < 20: # 确保有足够的帧用于验证集
             raise ValueError("实际加载的帧数不足以选择20帧作为验证集。")
except Exception as e:
    print(f"加载数据时出错: {e}")
    print("请确保CP2K输出文件 'tem.out' 存在于 './' 目录下且格式正确。")
    exit()

print('# 数据包含%d帧' % len(data))

# 1. 随机从总共 total_frames 帧中抽取 20 帧作为验证集索引（不重复）
if total_frames < 20:
    raise ValueError(f"总帧数 ({total_frames}) 不足以抽取20帧作为验证集。")
index_validation = np.random.choice(total_frames, size=20, replace=False)
index_validation = sorted(list(index_validation)) # 排序可选，但有助于后续理解

# 2. 其余帧中每隔5帧提取1帧作为训练集索引。
all_indices = list(range(total_frames))
potential_training_indices = sorted(list(set(all_indices) - set(index_validation)))

index_training = potential_training_indices[::5] # 从剩余的、排序后的索引中，每隔5个取一个

# 创建子系统
data_training = data.sub_system(index_training)
data_validation = data.sub_system(index_validation)

# 3. 将所有训练数据放入文件夹"training_data"中
data_training.to_deepmd_npy('./00.data/training_data')

# 4. 将所有验证数据放入文件夹"validation_data"中
data_validation.to_deepmd_npy('./00.data/validation_data')

print('# 训练数据包含%d帧' % len(data_training))
print('# 验证数据包含%d帧' % len(data_validation))
print(f'# 选取的训练集索引 (共 {len(index_training)} 帧): {index_training}')
print(f'# 选取的验证集索引 (共 {len(index_validation)} 帧): {index_validation}')
print(f'# 用于挑选训练集的候选索引 (共 {len(potential_training_indices)} 帧): {potential_training_indices}')
```


- 查看npy格式数据：各帧能量

```py
import dpdata
import numpy as np
energy=np.load('./00.data/training_data/set.000/energy.npy')
print(len(energy))
print(energy)
```


- 查看npy格式数据：帧数、原子总数，以及原子类型和各自数量

```py
import dpdata

# 读取整个 training_data 目录
system = dpdata.LabeledSystem('./00.data/training_data', fmt='deepmd/npy')

# 帧数
nframes = system.get_nframes()               # 或者 len(system['coords'])

# 每帧的原子总数
# coords 的形状是 (nframes, natoms, 3)
natoms_per_frame = system['coords'].shape[1]

# 原子类型列表
atom_types = system['atom_names']            # e.g. ['O', 'Si', 'Ca', 'Pt']

# 各种类原子数量
atom_counts = system['atom_numbs']           # e.g. [139, 40, 43, 8]

print(f'帧数：{nframes}')
print(f'每帧原子总数：{natoms_per_frame}')
print(f'原子种类：{atom_types}')
print(f'各种类原子数量：{atom_counts}')
```






### 5. 能量/力/坐标/盒子信息查看

1. 在执行训练/验证集数据划分前后，可以使用dpdata查看cp2k从头算输出的能量/力/坐标/盒子信息，相关语句如下：

```py
import dpdata
import numpy as np

# 使用LabeledSystem读取CP2K的AIMD输出文件；注意第一个参数是aimd输出所在的文件夹位置
data=dpdata.LabeledSystem('./',cp2k_output_name='tem.out',fmt='cp2kdata/md')
print('# 数据包含%d帧' % len(data))

# 直接打印所有帧的盒子张量
print(data["cells"])

# 最后一帧的能量
last_energy = data['energies'][-1]
print("Last frame energy:", last_energy)

# 最后一帧的力
last_forces = data['forces'][-1]
print("Last frame forces:", last_forces)

# 最后一帧的盒子张量
last_cell = data['cells'][-1]
print("Last frame cell matrix:\n", last_cell)

# 最后一帧的原子坐标
last_coords = data['coords'][-1]
print("Last frame coordinates:\n", last_coords)
```

2. 在使用 cp2kdata/md 格式读取 CP2K 输出时，dpdata 会自动做单位转换（见源码）：

   - 能量：CP2K 默认输出是 `Hartree`，dpdata 会乘以 `Hartree→eV` 的换算系数，所以 `data['energies']` 的单位是 `eV`。

   - 力：CP2K 默认是 `Hartree/Bohr`，dpdata 会乘以 `(eV/Å)/(Hartree/Bohr)` 的系数，所以 `data['forces']` 的单位是 `eV/Å`。


```
1 Hartree ≈ 27.2114 eV  
1 Hartree/Bohr ≈ 51.4221 eV/Å
```






## 4. AIMD多条轨迹数据转换

### 1. 官方案例

```py
from dpdata import MultiSystems
import glob
import os
# 定义一个空的MultiSystems
data=MultiSystems()

# 遍历轨迹所在文件夹
aimd_list=glob.glob('./00_aimd/*/output.log')
for idx,aimd_out in enumerate(aimd_list):
    dir_name=os.path.dirname(aimd_out)
    # 读取单个AIMD输出文件;并将其添加到MultiSystems中
    ls=dpdata.LabeledSystem(f'{dir_name}',cp2k_output_name='output.log',fmt='cp2kdata/md')
    if ls:
        data.append(ls)
print(data)

# 转化为deepmd的数据格式并输出到指定位置
data.to_deepmd_npy('./01_dp/aimd_all/',fmt='deepmd-npy')
! tree ./01_dp/aimd_all/
```



# 2. vasp输出文件格式转换












# 3. 相关资料

## 1. dpdata/cp2kdata

1. deepmodeling社区文档：
   - [快速上手DeePMD数据集准备 | CP2K篇](https://bohrium.dp.tech/notebooks/4041480191)
   - [dpdata官方文档](https://docs.deepmodeling.com/projects/dpdata/en/master/systems/system.html)
   - [dpdata.cp2k.output模块源码](https://docs.deepmodeling.com/projects/dpdata/en/master/_modules/dpdata/cp2k/output.html)
   - [dpdata包含的所有模块](https://docs.deepmodeling.com/projects/dpdata/en/master/py-modindex.html)

2. 计算化学公社相关讨论：
   - [关于DeePMD-Kit支持CP2K的数据格式的一个疑问](http://bbs.keinsci.com/thread-31149-1-1.html)


3. 相关github项目：
   - [dpdata](https://github.com/deepmodeling/dpdata)
   - [cp2k输出文件转deepmd-kit输入文件](https://github.com/KMNitesh05/cp2k_2_deepmdkit/blob/main/README.md)
   - [cp2kdata](https://github.com/robinzyb/cp2kdata)




## 2. deepmd-kit

1. deepmodeling社区文档：
   - [2.0.3版本deepmd上手教程](https://tutorials.deepmodeling.com/en/latest/Tutorials/DeePMD-kit/learnDoc/Handson-Tutorial%28v2.0.3%29.html#workflow-of-the-deepmd-kit)

2. 相关github项目：
   - [deepmd-kit](https://github.com/deepmodeling/deepmd-kit)



