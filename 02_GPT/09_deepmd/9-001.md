# 1. 数据格式转换

问题：
1. dpdata如何转换cp2k输出的AIMD数据？




# 1. dpdata和cp2kdata

## 1. 安装配置

### 1. dpdata安装

1. 安装

```sh
pip install dpdata

dpdata --version
```

### 2. `System` 和 `LabeledSystem` 支持的属性

| **键**          | **类型**          | **维度**                  | **是否标签** | **描述**           |
|-----------------|------------------|--------------------------|-------------|-------------------|
| `'atom_names'`  | `list of str`    | `ntypes`                | 否          | 原子类型名称       |
| `'atom_numbs'`  | `list of int`    | `ntypes`                | 否          | 每种类型的原子数量 |
| `'atom_types'`  | `np.ndarray`     | `natoms`                | 否          | 每个原子的类型分配 |
| `'cells'`       | `np.ndarray`     | `nframes x 3 x 3`       | 否          | 每帧的晶胞张量     |
| `'coords'`      | `np.ndarray`     | `nframes x natoms x 3`  | 否          | 原子坐标           |
| `'energies'`    | `np.ndarray`     | `nframes`               | 是          | 每帧的能量         |
| `'forces'`      | `np.ndarray`     | `nframes x natoms x 3`  | 是          | 每个原子的受力     |
| `'virials'`     | `np.ndarray`     | `nframes x 3 x 3`       | 是          | 每帧的应力张量     |



## 2. 单点能计算数据处理

### 1. 官方文档案例

1. cp2k单点能和从头算输出文件结构

```
./00_fp
├── 000
│   ├── STDOUTERR
│   ├── input.inp
│   ├── job_cp2k.json
│   ├── lbg-13387-8917799.sh
│   ├── lbg-13387-8917799.sh.bak
│   ├── lbg-13387-8918922.sh
│   ├── lbg-13387-8918922.sh.bak
│   └── output.log
└── 001
    ├── STDOUTERR
    ├── input.inp
    ├── job_cp2k.json
    ├── lbg-13387-8917816.sh
    ├── lbg-13387-8917816.sh.bak
    ├── lbg-13387-8918924.sh
    ├── lbg-13387-8918924.sh.bak
    └── output.log

2 directories, 16 files
./00_aimd
├── 000
│   ├── STDOUTERR
│   ├── aimd-1.ener
│   ├── aimd-1.restart
│   ├── aimd-1.restart.bak-1
│   ├── aimd-1.restart.bak-2
│   ├── aimd-frc-1.xyz
│   ├── aimd-pos-1.xyz
│   ├── input.inp
│   ├── job_cp2k.json
│   ├── lbg-13387-8917653.sh
│   ├── lbg-13387-8917653.sh.bak
│   ├── lbg-13387-8918919.sh
│   ├── lbg-13387-8918919.sh.bak
│   └── output.log
└── 001
    ├── STDOUTERR
    ├── aimd-1.ener
    ├── aimd-1.restart
    ├── aimd-1.restart.bak-1
    ├── aimd-1.restart.bak-2
    ├── aimd-frc-1.xyz
    ├── aimd-pos-1.xyz
    ├── input.inp
    ├── job_cp2k.json
    ├── lbg-13387-8917688.sh
    ├── lbg-13387-8917688.sh.bak
    ├── lbg-13387-8918920.sh
    ├── lbg-13387-8918920.sh.bak
    └── output.log

2 directories, 28 files
```


2. cp2k单点能计算输入文件示例

```bash
#Generated by Multiwfn
&GLOBAL
  PROJECT data_md_ave
  PRINT_LEVEL MEDIUM
  RUN_TYPE ENERGY_FORCE
&END GLOBAL

&FORCE_EVAL
  METHOD Quickstep
  STRESS_TENSOR ANALYTICAL
  &SUBSYS
    &CELL
      A     22.27050018      0.00000000      0.00000000
      B      0.00000000     22.27050018      0.00000000
      C      0.00000000      0.00000000     22.27050018
      PERIODIC XYZ #Direction(s) of applied PBC (geometry aspect)
    &END CELL
    &COORD
      C            0.104120    19.891457    16.117207
      C           22.148861    21.201803    16.862242
      O            0.661542    22.181522    16.080223
      ......
      # 省略原子坐标
      H           18.236288    17.427950    18.632980
      H           17.611443    18.594219    19.880655
      H           15.624798    17.594215    19.592993
      H           16.069569    16.531801    18.298908
    &END COORD
#   &VELOCITY #You can set initial atomic velocities in this section
#   &END VELOCITY
    &KIND C
      ELEMENT C
      BASIS_SET TZV2P-GTH-q4
      POTENTIAL GTH-PBE
    &END KIND
    &KIND O
      ELEMENT O
      BASIS_SET TZV2P-GTH-q6
      POTENTIAL GTH-PBE
    &END KIND
    &KIND H
      ELEMENT H
      BASIS_SET TZV2P-GTH-q1
      POTENTIAL GTH-PBE
    &END KIND
    &KIND Li
      ELEMENT Li
      BASIS_SET TZV2P-GTH-q3
      POTENTIAL GTH-PBE
    &END KIND
    &KIND P
      ELEMENT P
      BASIS_SET TZV2P-GTH-q5
      POTENTIAL GTH-PBE
    &END KIND
    &KIND F
      ELEMENT F
      BASIS_SET TZV2P-GTH-q7
      POTENTIAL GTH-PBE
    &END KIND
  &END SUBSYS

  &DFT
    BASIS_SET_FILE_NAME  GTH_BASIS_SETS
    POTENTIAL_FILE_NAME  POTENTIAL
#   WFN_RESTART_FILE_NAME md_ave_10-RESTART.wfn
    CHARGE    0 #Net charge
    MULTIPLICITY    1 #Spin multiplicity
    &QS
      EPS_DEFAULT 1.0E-10 #Set all EPS_xxx to values such that the energy will be correct up to this value
      EXTRAPOLATION ASPC #Extrapolation for wavefunction during e.g. MD. ASPC is default, PS can also be used
      EXTRAPOLATION_ORDER 3 #Order for PS or ASPC extrapolation. 3 is default
    &END QS
    &POISSON
      PERIODIC XYZ #Direction(s) of PBC for calculating electrostatics
      PSOLVER PERIODIC #The way to solve Poisson equation
    &END POISSON
    &XC
      &XC_FUNCTIONAL PBE
      &END XC_FUNCTIONAL
      &VDW_POTENTIAL
        POTENTIAL_TYPE PAIR_POTENTIAL
        &PAIR_POTENTIAL
          PARAMETER_FILE_NAME dftd3.dat
          TYPE DFTD3(BJ)
          REFERENCE_FUNCTIONAL PBE
          #CALCULATE_C9_TERM T #Calculate C9-related three-body term, more accurate for large system
        &END PAIR_POTENTIAL
      &END VDW_POTENTIAL
    &END XC
    &MGRID
      CUTOFF  800
      REL_CUTOFF  40
      NGRIDS 5 #The number of multigrids to use. 5 is optimal for MOLOPT-GTH basis sets
    &END MGRID
    &SCF
      MAX_SCF 25 #Maximum number of steps of inner SCF
      EPS_SCF 1.0E-05 #Convergence threshold of density matrix of inner SCF
#     SCF_GUESS RESTART #Use wavefunction from WFN_RESTART_FILE_NAME file as initial guess
      &OT
        PRECONDITIONER FULL_KINETIC #FULL_SINGLE_INVERSE is also worth to try. FULL_ALL is better but quite expensive for large system
        MINIMIZER DIIS #CG is worth to consider in difficult cases
        LINESEARCH 2PNT #1D line search algorithm for CG. 2PNT is default, 3PNT is better but more costly. GOLD is best but very expensive
        ALGORITHM STRICT #Algorithm of OT. Can be STRICT (default) or IRAC
      &END OT
      &OUTER_SCF
        MAX_SCF 20 #Maximum number of steps of outer SCF
        EPS_SCF 1.0E-05 #Convergence threshold of outer SCF
      &END OUTER_SCF
      &PRINT
        &RESTART OFF #Do not generate wfn file to suppress meaningless I/O cost
        &END RESTART
      &END PRINT
    &END SCF
  &END DFT
  &PRINT
    &FORCES ON           #Print atomic forces
    &END FORCES
  &END PRINT
&END FORCE_EVAL
```


3. 单点能计算数据转换官方示例


```py
# 更新dpdata,cp2kdata
! pip install -U dpdata
! pip install -U cp2kdata
import dpdata
import numpy as np


# 使用LabeledSystem读取CP2K的单点能输出文件
data=dpdata.LabeledSystem('00_fp/000/output.log',fmt='cp2k/output')
print(data)


# 指定元素顺序进行dpdata读取/转换
data=dpdata.LabeledSystem('00_fp/000/output.log',fmt='cp2k/output',type_map=['H','C','O'])
print(data)


# 转化为deepmd的数据格式并输出到指定位置
data.to_deepmd_npy('./01_dp/fp_single/',fmt='deepmd-npy')
! tree ./01_dp/fp_single/


# npy格式的文件读取,以energy为例
energy=np.load('./01_dp/fp_single/set.000/energy.npy')
print(len(energy))
print(energy)


# 使用LabeledSystem读取文件夹下多个CP2K的单点能输出文件
data=dpdata.MultiSystems.from_dir('00_fp',file_name='output.log',fmt='cp2k/output')
print(data)
print(data.systems)


# 转化为deepmd的数据格式并输出到指定位置
data.to_deepmd_npy('./01_dp/fp_all/',fmt='deepmd-npy')
! tree ./01_dp/fp_all/
```




### 2. cp2k单点能计算输出文件

- cp2k控制文件
  - `PRINT_LEVEL` 设置为 `MEDIUM`
  - `RUN_TYPE` 设置为 `ENERGY_FORCE`
  - `FORCE_EVAL`下的`&PRINT`打印`FORCES`

```inp
&GLOBAL
    PRINT_LEVEL MEDIUM
    PROJECT_NAME ${SYSNAME}
    RUN_TYPE ENERGY_FORCE
&END GLOBAL

&FORCE_EVAL
    METHOD  QS
    &DFT
        ...   
    &END DFT
    &SUBSYS
        ...
    &END SUBSYS
    &PRINT
        &FORCES ON           #Print atomic forces
        &END FORCES
    &END PRINT
&END FORCE_EVAL
```



- cmd命令依次执行如下命令

`tem.out`是cp2k单点能计算输出文件（包含运行信息、体系信息和计算结果等），cp2k计算的任务类型是 `RUN_TYPE ENERGY_FORCE`。使用关键词`cp2k/output`指定`tem.out`文件类型

```python
# 使用LabeledSystem读取CP2K的单点能输出文件
import dpdata
import numpy as np
data=dpdata.LabeledSystem('tem.out',fmt='cp2k/output')
print(data)
print(data["coords"])
print(data["energies"])
print(data["forces"])
# 转化为deepmd的数据格式并输出到指定位置（当前目录的子文件夹 sub_folder ）
data.to_deepmd_npy('./sub_folder/',fmt='deepmd-npy')
```



- 示例输出

```
Type "help", "copyright", "credits" or "license" for more information.
>>> import dpdata
>>> import numpy as np
>>> data=dpdata.LabeledSystem('tem.out',fmt='cp2k/output')

>>> print(data)
Data Summary
Labeled System
-------------------
Frame Numbers      : 1
Atom Numbers       : 226
Including Virials  : No
Element List       :
-------------------
B  O  Si  Ca
8  135  40  43

>>> print(data["coords"])
[[[1.5307190e+00 1.2526217e+01 1.0197713e+01]
  [8.7254510e+00 8.6880330e+00 7.0680320e+00]
  [9.1087680e+00 5.5990580e+00 6.6161680e+00]
  ......
  [4.0823450e+00 1.0573016e+01 9.3888270e+00]
  [8.1104590e+00 4.1514110e+00 4.3153410e+00]
  [2.8667400e+00 3.6892390e+00 1.2441217e+01]
  [2.7173800e-01 5.2957740e+00 3.3176500e-01]]]

>>> print(data["energies"])
[-107106.42005917]

>>> print(data["forces"])
[[[-1.95376551  1.73994587 -0.73027101]
  [ 0.85260668  1.21704721  1.95160527]
  [ 0.13513565  0.20607959 -0.38610208]
  ......
  [-0.8725101  -0.01692403  0.68197951]
  [-0.53420638  1.33620859 -0.5776138 ]
  [ 0.54489497  0.50672848 -0.04356066]
  [ 2.10692203 -0.31649768  1.58288848]]]
```

- 命令`data.to_deepmd_npy('./sub_folder/',fmt='deepmd-npy')`执行后生成的新目录结构

```
├── sub_folder
    ├── set.000
        ├── box.npy
        ├── coord.npy
        ├── energy.npy
        └── force.npy
    ├── type.raw
    └── type_map.raw
```

上述输出的各文件内容如下：

- `set.000/` 包含数值数据文件：
  - `box.npy`：模拟盒子的几何信息
  - `coord.npy`：原子的三维坐标
  - `energy.npy`：每个配置的总能量
  - `force.npy`：每个原子的力信息
- `type.raw` 定义了数据集中所有原子的类型（如元素种类）。
- `type_map.raw` 提供原子类型与模型内部标识符之间的映射关系。




### 3. 输出为deepmd数据和npy数据读取

`.npy` 数据格式是 NumPy 提供的一种专用二进制文件格式，用于高效存储和读取 NumPy 数组

- 命令行：

```py
import dpdata
import numpy as np
energy=np.load('./deepmd_fmt/set.000/energy.npy')
print(len(energy))
print(energy)
```

- 输出示例：

```
>>> print(len(energy))
1
>>> print(energy)
[[-107106.42005917]]
```





## 3. AIMD单条轨迹数据转换

### 1. 官方文档案例

- cp2k计算控制文件

```bash
#Generated by Multiwfn
&GLOBAL
  PROJECT aimd
  PRINT_LEVEL MEDIUM
  RUN_TYPE MD
&END GLOBAL

&FORCE_EVAL
  METHOD Quickstep
  STRESS_TENSOR ANALYTICAL
  &SUBSYS
    &CELL
      A     17.67609978      0.00000000      0.00000000
      B      0.00000000     17.67609978      0.00000000
      C      0.00000000      0.00000000     17.67609978
      PERIODIC XYZ #Direction(s) of applied PBC (geometry aspect)
    &END CELL
    &COORD
      C            7.760000    13.760000     7.720000
      C            8.940000    12.820000     7.550000
      O            9.350000    13.110000     6.220000
      ......
      # 省略原子坐标
      H           11.080000    11.420000     4.860000
      H           11.520000    13.660001     5.350000
      H           11.530000    13.830000     3.580000
    &END COORD
#   &VELOCITY #You can set initial atomic velocities in this section
#   &END VELOCITY
    &KIND C
      ELEMENT C
      BASIS_SET TZV2P-GTH-q4
      POTENTIAL GTH-PBE
    &END KIND
    &KIND O
      ELEMENT O
      BASIS_SET TZV2P-GTH-q6
      POTENTIAL GTH-PBE
    &END KIND
    &KIND H
      ELEMENT H
      BASIS_SET TZV2P-GTH-q1
      POTENTIAL GTH-PBE
    &END KIND
    &KIND Li
      ELEMENT Li
      BASIS_SET TZV2P-GTH-q3
      POTENTIAL GTH-PBE
    &END KIND
    &KIND P
      ELEMENT P
      BASIS_SET TZV2P-GTH-q5
      POTENTIAL GTH-PBE
    &END KIND
    &KIND F
      ELEMENT F
      BASIS_SET TZV2P-GTH-q7
      POTENTIAL GTH-PBE
    &END KIND
  &END SUBSYS

  &DFT
    BASIS_SET_FILE_NAME  GTH_BASIS_SETS
    POTENTIAL_FILE_NAME  POTENTIAL
#   WFN_RESTART_FILE_NAME md_ave_10-RESTART.wfn
    CHARGE    0 #Net charge
    MULTIPLICITY    1 #Spin multiplicity
    &QS
      EPS_DEFAULT 1.0E-10 #Set all EPS_xxx to values such that the energy will be correct up to this value
      EXTRAPOLATION ASPC #Extrapolation for wavefunction during e.g. MD. ASPC is default, PS can also be used
      EXTRAPOLATION_ORDER 3 #Order for PS or ASPC extrapolation. 3 is default
    &END QS
    &POISSON
      PERIODIC XYZ #Direction(s) of PBC for calculating electrostatics
      PSOLVER PERIODIC #The way to solve Poisson equation
    &END POISSON
    &XC
      &XC_FUNCTIONAL PBE
      &END XC_FUNCTIONAL
      &VDW_POTENTIAL
        POTENTIAL_TYPE PAIR_POTENTIAL
        &PAIR_POTENTIAL
          PARAMETER_FILE_NAME dftd3.dat
          TYPE DFTD3(BJ)
          REFERENCE_FUNCTIONAL PBE
          #CALCULATE_C9_TERM T #Calculate C9-related three-body term, more accurate for large system
        &END PAIR_POTENTIAL
      &END VDW_POTENTIAL
    &END XC
    &MGRID
      CUTOFF  800
      REL_CUTOFF  40
      NGRIDS 5 #The number of multigrids to use. 5 is optimal for MOLOPT-GTH basis sets
    &END MGRID
    &SCF
      MAX_SCF 25 #Maximum number of steps of inner SCF
      EPS_SCF 1.0E-05 #Convergence threshold of density matrix of inner SCF
#     SCF_GUESS RESTART #Use wavefunction from WFN_RESTART_FILE_NAME file as initial guess
      &OT
        PRECONDITIONER FULL_KINETIC #FULL_SINGLE_INVERSE is also worth to try. FULL_ALL is better but quite expensive for large system
        MINIMIZER DIIS #CG is worth to consider in difficult cases
        LINESEARCH 2PNT #1D line search algorithm for CG. 2PNT is default, 3PNT is better but more costly. GOLD is best but very expensive
        ALGORITHM STRICT #Algorithm of OT. Can be STRICT (default) or IRAC
      &END OT
      &OUTER_SCF
        MAX_SCF 20 #Maximum number of steps of outer SCF
        EPS_SCF 1.0E-05 #Convergence threshold of outer SCF
      &END OUTER_SCF
      &PRINT
        &RESTART OFF #Do not generate wfn file to suppress meaningless I/O cost
        &END RESTART
      &END PRINT
    &END SCF
  &END DFT
&END FORCE_EVAL

&MOTION
  &MD
    ENSEMBLE NVT
    STEPS 50 #Number of steps to run
    TIMESTEP 1.0 #Step size in fs. Decrease it properly for high temperature simulation
    TEMPERATURE 300 #Initial and maintained temperature (K)
#   COMVEL_TOL 0 #Uncomment this can remove translation motion of center-of-mass every step
    &THERMOSTAT
      TYPE CSVR
      &CSVR
        TIMECON 25 #Time constant in fs. Smaller/larger results in stronger/weaker temperature coupling
      &END CSVR
    &END THERMOSTAT
  &END MD
  
  &PRINT
    &TRAJECTORY
      &EACH
        MD   1 #Output frequency of coordinates, 0 means never
      &END EACH
      FORMAT xyz
    &END TRAJECTORY
    &FORCES
      &EACH
        MD   1 #Output frequency of forces, 0 means never
      &END EACH
    &END FORCES
#    &RESTART
#      BACKUP_COPIES 0 #Maximum number of backing up restart file, 0 means never
#      &EACH
#        MD  10 #Frequency of updating last restart file, 0 means never
#      &END EACH
#    &END RESTART
  &END PRINT
&END MOTION

```




- 数据转换命令

```py
import dpdata
import numpy as np

# 使用LabeledSystem读取CP2K的AIMD输出文件；注意第一个参数是aimd输出所在的文件夹位置
data=dpdata.LabeledSystem('./00_aimd/000/',cp2k_output_name='output.log',fmt='cp2kdata/md')
print(data)

# 转化为deepmd的数据格式并输出到指定位置
data.to_deepmd_npy('./01_dp/aimd_single/',fmt='deepmd-npy')
! tree ./01_dp/aimd_single/
```



## 4. AIMD多条轨迹数据转换

### 1. 官方案例

```py
from dpdata import MultiSystems
import glob
import os
# 定义一个空的MultiSystems
data=MultiSystems()

# 遍历轨迹所在文件夹
aimd_list=glob.glob('./00_aimd/*/output.log')
for idx,aimd_out in enumerate(aimd_list):
    dir_name=os.path.dirname(aimd_out)
    # 读取单个AIMD输出文件;并将其添加到MultiSystems中
    ls=dpdata.LabeledSystem(f'{dir_name}',cp2k_output_name='output.log',fmt='cp2kdata/md')
    if ls:
        data.append(ls)
print(data)

# 转化为deepmd的数据格式并输出到指定位置
data.to_deepmd_npy('./01_dp/aimd_all/',fmt='deepmd-npy')
! tree ./01_dp/aimd_all/
```













### 相关资料

1. deepmodeling社区文档：
   - [快速上手DeePMD数据集准备 | CP2K篇](https://bohrium.dp.tech/notebooks/4041480191)
   - [dpdata官方文档](https://docs.deepmodeling.com/projects/dpdata/en/master/systems/system.html)
   - [dpdata.cp2k.output模块源码](https://docs.deepmodeling.com/projects/dpdata/en/master/_modules/dpdata/cp2k/output.html)
   - [dpdata包含的所有模块](https://docs.deepmodeling.com/projects/dpdata/en/master/py-modindex.html)

2. 计算化学公社相关讨论：
   - [关于DeePMD-Kit支持CP2K的数据格式的一个疑问](http://bbs.keinsci.com/thread-31149-1-1.html)


3. 相关github项目：
   - [dpdata](https://github.com/deepmodeling/dpdata)
   - [cp2k输出文件转deepmd-kit输入文件](https://github.com/KMNitesh05/cp2k_2_deepmdkit/blob/main/README.md)
   - [cp2kdata](https://github.com/robinzyb/cp2kdata)






# 2. deepmd-kit

1. deepmodeling社区文档：
   - [2.0.3版本deepmd上手教程](https://tutorials.deepmodeling.com/en/latest/Tutorials/DeePMD-kit/learnDoc/Handson-Tutorial%28v2.0.3%29.html#workflow-of-the-deepmd-kit)

2. 相关github项目：
   - [deepmd-kit](https://github.com/deepmodeling/deepmd-kit)



