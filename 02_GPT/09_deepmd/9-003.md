# deepmd-kit官方入门案例

# 1. 模型参数

## 1. 模型的组成与配置

**1. 模型定义**

在 `input.json` 文件中，模型通过 `"model"` 节点定义，包含以下主要部分：

- `type_map`（可选）：提供原子类型对应的元素名称（例如水模型中 "O" 和 "H"），内部记录时通常用整数表示（例如 0 表示氧，1 表示氢）。
- `descriptor`：描述符部分，用于将原子结构转换为对称不变量特征。
- `fitting_net`：拟合网络部分，基于描述符预测原子贡献的物理量。


**2. 描述符种类**

DeePMD-kit 实现了多种描述符，每种描述符侧重于不同信息的提取：

- `se_e2_a`：利用原子间距离（径向信息）构造 DeepPot-SE，同时结合角度（角向信息）。
- `se_e2_r`：仅基于径向信息构造 DeepPot-SE。
- `se_e3`：利用角度信息（以及部分径向信息）构造 DeepPot-SE，输入为邻近原子之间的夹角。
- `se_a_mask`：适用于原子数目不固定的输入情况，采用虚拟原子填充以保证输入数据维度一致。
- `loc_frame`：为每个原子建立局部坐标系，并在该局部坐标系下计算描述符。
- `hybrid`：将多种描述符拼接成一个新的描述符，用以捕获更多信息。


**3. 拟合物理量**

模型可以用来拟合多种物理性质，包括：

- `ener`：系统能量，同时也可以训练得到力和应力张量（virial）的信息。
- `dipole`：分子或系统的偶极矩。
- `polar`：极化率。



## 2. 模型描述符

### 1. `se_e2_a`

“se_e2_a” 全称为 Deep Potential Smooth Edition（DeepPot-SE），利用原子配置中的所有信息（角向和径向）构造描述符。

“e2” 表示采用“两原子信息”进行嵌入，即虽然嵌入网络只以原子间距离作为输入，但描述符本身能编码多体（角度和径向）信息。


- 平滑切换函数

```math
    s(r)=
    \begin{cases}
    \frac{1}{r}, & r \lt r_s, \\
    \frac{1}{r} \big[ x^3 (-6 x^2 +15 x -10) +1 \big], & r_s \leq r \lt r_c, \\
    0, & r \geq r_c,
    \end{cases}
```



```json
	"descriptor" :{
	    "type":		"se_e2_a",
	    "rcut_smth":	0.50,
	    "rcut":		6.00,
	    "sel":		[46, 92],
	    "neuron":		[25, 50, 100],
	    "type_one_side":	true,
	    "axis_neuron":	16,
	    "resnet_dt":	false,
	    "seed":		1
	}
```

type：指定使用 se_e2_a 描述符。

rcut_smth 与 rcut：分别定义平滑起始半径与邻居搜索的截断半径。

sel：以列表形式给出不同原子类型在截断半径内的最大邻居数。

neuron：定义嵌入网络中各层的神经元数量。若外层大小为内层的两倍，则采用 ResNet 结构进行复制拼接。

type_one_side：若设置为 true，则仅根据邻居原子类型决定嵌入网络参数；若为 false，则中心原子和邻居原子类型均会影响参数

axis_neuron：指定嵌入矩阵中用于轴方向（axis）的子矩阵大小。

resnet_dt：布尔选项，若为 true，则在 ResNet 结构中使用时间步长信息。

seed：随机种子，用于初始化模型参数。






## 参考资料

- deepmd-kit官方github案例：https://github.com/deepmodeling/deepmd-kit/tree/r3.0/examples
- deepmd-kit官方英文文档：https://docs.deepmodeling.com/projects/deepmd/en/stable/model/index.html




# 2. 甲烷分子（v2.0.3）

## 1. 数据准备

1. 数据下载

官方下载链接：https://dp-public.oss-cn-beijing.aliyuncs.com/community/CH4.tar

浏览器中可直接下载，windows直接解压缩


2. 数据目录

```
├── CH4
    ├── 00.data
        └── OUTCAR
    ├── 01.train
        └── input.json
    └── 02.lmp
        ├── conf.lmp
        └── in.lammps
```

OUTCAR：vasp详细的计算日志，记录所有计算过程中的关键信息（如能量、力、应力、原子位置、电子自洽迭代等）。是分析计算结果的主要文件。


3. 提取训练数据和测试数据

```py
import dpdata  # 导入dpdata模块，用于处理材料计算数据
import numpy as np  # 导入NumPy库，用于数值计算

# 读取VASP输出文件'OUTCAR'，并以'vasp/outcar'格式解析，生成一个包含多个帧的系统数据
data = dpdata.LabeledSystem('OUTCAR', fmt='vasp/outcar')  

# 打印数据中包含的帧数
print('# the data contains %d frames' % len(data))  

# 从前200帧中随机选择40帧作为验证集，确保不重复选择
index_validation = np.random.choice(200, size=40, replace=False)

# 将剩余帧（即不在验证集中的帧）作为训练集的索引
index_training = list(set(range(200)) - set(index_validation))

# 从原始数据中提取训练集子系统，包含index_training指定的帧
data_training = data.sub_system(index_training)

# 从原始数据中提取验证集子系统，包含index_validation指定的帧
data_validation = data.sub_system(index_validation)

# 将训练数据保存为DeepMD格式的NumPy数组，目录为'training_data'
data_training.to_deepmd_npy('training_data')

# 将验证数据保存为DeepMD格式的NumPy数组，目录为'validation_data'
data_validation.to_deepmd_npy('validation_data')

# 打印训练数据中包含的帧数
print('# the training data contains %d frames' % len(data_training)) 

# 打印验证数据中包含的帧数
print('# the validation data contains %d frames' % len(data_validation))
```

从VASP输出文件中读取材料计算数据，并将前200帧随机分成40帧的验证集和160帧的训练集，随后将这两个数据集分别保存为DeepMD格式，并打印出各自包含的帧数。

- 运行上述代码后生成如下文件目录（新生成`training_data`和`validation_data` 文件夹）

```
├── 00.data
    ├── OUTCAR
    ├── training_data
        ├── set.000
        ├── type.raw
        └── type_map.raw
    └── validation_data
        ├── set.000
        ├── type.raw
        └── type_map.raw
```



## 2. 训练输入脚本

### 1. 示例脚本

- `input.json`

```json
{
    "_comment": " model parameters",
    "model": {
	"type_map":	["H", "C"],
	"descriptor" :{
	    "type":		"se_e2_a",
	    "sel":		[4, 1],
	    "rcut_smth":	0.50,
	    "rcut":		6.00,
	    "neuron":		[10, 20, 40],
	    "resnet_dt":	false,
	    "axis_neuron":	4,
	    "seed":		1,
	    "_comment":		" that's all"
	},
	"fitting_net" : {
	    "neuron":		[100, 100, 100],
	    "resnet_dt":	true,
	    "seed":		1,
	    "_comment":		" that's all"
	},
	"_comment":	" that's all"
    },

    "learning_rate" :{
	"type":		"exp",
	"decay_steps":	5000,
	"start_lr":	0.001,	
	"stop_lr":	3.51e-8,
	"_comment":	"that's all"
    },

    "loss" :{
	"type":		"ener",
	"start_pref_e":	0.02,
	"limit_pref_e":	1,
	"start_pref_f":	1000,
	"limit_pref_f":	1,
	"start_pref_v":	0,
	"limit_pref_v":	0,
	"_comment":	" that's all"
    },

    "training" : {
	"training_data": {
	    "systems":		["../00.data/training_data"],
	    "batch_size":	"auto",
	    "_comment":		"that's all"
	},
	"validation_data":{
	    "systems":		["../00.data/validation_data"],
	    "batch_size":	"auto",
	    "numb_btch":	1,
	    "_comment":		"that's all"
	},
	"numb_steps":	1000000,
	"seed":		10,
	"disp_file":	"lcurve.out",
	"disp_freq":	1000,
	"save_freq":	10000,
	"_comment":	"that's all"
    },    

    "_comment":		"that's all"
}
```




## 3. 模型训练



## 4. 冻结/压缩模型


## 5. 模型测试


## 6. lammps运行





## 参考资料

- [上机教程v2.0.3版本](https://tutorials.deepmodeling.com/zh-cn/latest/Tutorials/DeePMD-kit/learnDoc/Handson-Tutorial%28v2.0.3%29.html)
- [训练甲烷深度势能分子动力学模型v2.2.1版本](https://bohrium.dp.tech/notebooks/3313403083)
